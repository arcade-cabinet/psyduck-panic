name: CD - Continuous Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write
  issues: write # For Jules action

concurrency:
  group: 'cd-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  # Call CI workflow for quality checks (lint, typecheck, unit tests, build)
  # E2E smoke tests are skipped in CI during CD since we run full E2E matrix below
  ci:
    name: Run CI Quality Checks
    uses: ./.github/workflows/ci.yml
    with:
      skip-e2e: true  # Skip smoke tests; full E2E matrix runs below
    permissions:
      contents: read

  # Build project once and upload artifact for E2E tests
  # This avoids rebuilding 17 times in the matrix
  build-for-e2e:
    name: Build for E2E Tests
    runs-on: ubuntu-latest
    needs: [ci]
    permissions:
      contents: read
    steps:
      # Checkout repository
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      # Setup Node.js environment with pnpm and caching
      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js with cache
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      
      # Install dependencies (cached by setup-node)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Build project once for all E2E tests
      - name: Build project
        run: pnpm build
      
      # Upload build artifact for E2E tests
      - name: Upload build artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist-e2e
          path: dist/
          retention-days: 1

  # Full E2E matrix: Test all device profiles in parallel
  # This is the comprehensive test suite for production deployments
  e2e-full-matrix:
    name: E2E - ${{ matrix.device }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-for-e2e]
    strategy:
      fail-fast: false
      matrix:
        device: 
          # Desktop browsers - 3 devices
          - 'Desktop Chrome'
          - 'Desktop Firefox'
          - 'Desktop Safari'
          # Phones - Portrait (5 devices)
          - 'iPhone 12 Portrait'
          - 'iPhone 12 Pro Portrait'
          - 'iPhone 13 Portrait'
          - 'iPhone 14 Portrait'
          - 'Pixel 5 Portrait'
          - 'Galaxy S21 Portrait'
          # Phones - Landscape (2 devices)
          - 'iPhone 12 Landscape'
          - 'Pixel 5 Landscape'
          # Tablets - Portrait (2 devices)
          - 'iPad Pro 11 Portrait'
          - 'iPad Pro 12.9 Portrait'
          # Tablets - Landscape (1 device)
          - 'iPad Pro 11 Landscape'
          # Foldables (4 devices)
          - 'Samsung Galaxy Fold Folded'
          - 'Samsung Galaxy Fold Unfolded'
          - 'Surface Duo Portrait'
          - 'Surface Duo Landscape'
    permissions:
      contents: read
    steps:
      # Checkout repository
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      # Setup Node.js environment with pnpm and caching
      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js with cache
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      
      # Install dependencies (cached by setup-node)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Download pre-built artifact instead of rebuilding
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist-e2e
          path: dist/
      
      # Install only the required browser for this device to save time
      - name: Install Playwright Browsers
        run: |
          if [[ "${{ matrix.device }}" == *"Chrome"* ]] || [[ "${{ matrix.device }}" == *"Galaxy"* ]] || [[ "${{ matrix.device }}" == *"Pixel"* ]]; then
            pnpm exec playwright install --with-deps chromium
          elif [[ "${{ matrix.device }}" == *"Firefox"* ]]; then
            pnpm exec playwright install --with-deps firefox
          elif [[ "${{ matrix.device }}" == *"Safari"* ]] || [[ "${{ matrix.device }}" == *"iPad"* ]] || [[ "${{ matrix.device }}" == *"iPhone"* ]]; then
            pnpm exec playwright install --with-deps webkit
          else
            pnpm exec playwright install --with-deps chromium
          fi
      
      # Run E2E test for this specific device
      - name: Run Playwright tests on ${{ matrix.device }}
        run: pnpm exec playwright test --project="${{ matrix.device }}"
      
      # Upload test results only on failure to save storage
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-${{ matrix.device }}-report
          path: playwright-report/
          retention-days: 7
  
  # Jules Action: Auto-heal any CD failures by aggregating errors
  # Uses Google's Jules AI agent to automatically fix common CI/CD issues
  auto-heal-failures:
    name: Auto-heal CD Failures
    runs-on: ubuntu-latest
    if: failure()
    needs: [ci, e2e-full-matrix]
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: google-labs-code/jules-action@bff7875eaa123cac6742b7cfc51005b95ba4d566 # v1.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          google-jules-api-key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          task: |
            The CD pipeline has failed on the main branch. Please analyze all failures and fix them:
            
            1. Aggregate all errors from failed jobs (CI quality checks, E2E matrix tests)
            2. Fix linting errors with auto-fixes
            3. Fix TypeScript compilation errors
            4. Fix failing unit tests
            5. Fix failing E2E tests across all device profiles
            6. Ensure the build succeeds
            
            Run all checks locally to verify fixes before committing to main.
            
            If fixes cannot be automated, create a detailed issue with:
            - All aggregated error messages
            - Failed device profiles (for E2E)
            - Suggested remediation steps


  # Release Please - Creates release PRs based on conventional commits
  # Only runs after all quality gates pass (CI + full E2E matrix)
  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    needs: [ci, e2e-full-matrix]
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          release-type: node
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Build and deploy to GitHub Pages
  # Runs in parallel with E2E matrix after CI passes (doesn't need to wait for E2E)
  build-pages:
    name: Build for GitHub Pages
    runs-on: ubuntu-latest
    needs: [ci]
    permissions:
      contents: read
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      # Setup Node.js environment with pnpm and caching
      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js with cache
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      
      # Configure GitHub Pages metadata
      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0
      
      # Install dependencies (cached by setup-node)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Build production bundle
      - name: Build Vite project
        run: pnpm build
      
      # Upload build for deployment
      - name: Upload artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: './dist'

  # Deploy to GitHub Pages (runs after build-pages and E2E matrix complete)
  deploy-pages:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build-pages, e2e-full-matrix]
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

  # Collector job that waits for all CD checks to complete
  # Ensures CI, E2E matrix, and deployment all succeeded
  cd-success:
    name: CD Success
    runs-on: ubuntu-latest
    if: always()
    needs: [ci, e2e-full-matrix, release-please, build-pages, deploy-pages]
    steps:
      - name: Check CD status
        run: |
          # Check if all required jobs succeeded
          if [[ "${{ needs.ci.result }}" != "success" ]]; then
            echo "❌ CI checks failed"
            exit 1
          fi
          
          if [[ "${{ needs.e2e-full-matrix.result }}" != "success" ]]; then
            echo "❌ E2E matrix tests failed"
            exit 1
          fi
          
          if [[ "${{ needs.release-please.result }}" != "success" ]]; then
            echo "❌ Release Please failed"
            exit 1
          fi
          
          if [[ "${{ needs.build-pages.result }}" != "success" ]]; then
            echo "❌ Build pages failed"
            exit 1
          fi
          
          if [[ "${{ needs.deploy-pages.result }}" != "success" ]]; then
            echo "❌ Deploy pages failed"
            exit 1
          fi
          
          echo "✅ All CD checks passed"

