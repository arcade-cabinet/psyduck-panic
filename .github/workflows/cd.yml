name: CD

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ── Deploy Expo Web to GitHub Pages ──
  deploy-web:
    name: Deploy Web to GitHub Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Build Expo Web (Production)
        run: pnpm build:web
        env:
          GITHUB_PAGES: "true"

      - name: Add .nojekyll
        run: touch dist/.nojekyll

      - name: Upload Web Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build-dist
          path: dist/
          retention-days: 90

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ── Build and Upload Android Release APK ──
  deploy-android:
    name: Deploy Android Release APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ hashFiles('android/**/*.gradle*', 'android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease --no-daemon

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v3.0.0-${{ github.run_number }}
          name: "v3.0.0 Build ${{ github.run_number }}"
          body: |
            ## Cognitive Dissonance v3.0.0

            Cross-platform release from commit ${{ github.sha }}.

            ### Downloads
            - **Web**: https://arcade-cabinet.github.io/cognitive-dissonance/
            - **Android APK**: Attached below (release build)

            ### What's New
            Complete v3.0 cross-platform implementation:
            - Reactylon Native + Babylon.js 8 + Metro bundler
            - Dual AR/MR modes (glasses room-scale + phone camera projection)
            - Miniplex ECS architecture with 4 level archetypes
            - Procedural morph-based enemies with 7 Yuka AI traits
            - Crystalline-cube boss with 5-phase GSAP timeline
            - Logarithmic difficulty scaling system
            - WebGPU rendering on web, Babylon Native on mobile
          files: android/app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: true
          generate_release_notes: false
          token: ${{ secrets.GITHUB_TOKEN }}

  # ── EAS Build iOS (Preview Profile) ──
  deploy-ios:
    name: Deploy iOS via EAS Build
    runs-on: ubuntu-latest
    if: vars.EAS_PROJECT_ID != ''
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Check EXPO_TOKEN is available
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "::warning::EXPO_TOKEN secret is not set. Skipping iOS EAS build."
            echo "SKIP_EAS=true" >> "$GITHUB_ENV"
          else
            echo "EXPO_TOKEN is configured"
            echo "SKIP_EAS=false" >> "$GITHUB_ENV"
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Setup Expo
        if: env.SKIP_EAS != 'true'
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: EAS Build (iOS Preview)
        if: env.SKIP_EAS != 'true'
        run: eas build --platform ios --profile preview --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
