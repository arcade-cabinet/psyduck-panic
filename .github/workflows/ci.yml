name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm exec tsc --noEmit

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:coverage
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: unit-test-reports
          path: coverage/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: dist/
          retention-days: 1

  e2e-smoke:
    name: E2E Smoke Tests - Desktop Chrome
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: dist/
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
      - name: Run E2E smoke tests
        run: pnpm exec playwright test --project="Desktop Chrome" --workers=1
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: e2e-smoke-reports
          path: playwright-report/
          retention-days: 7

  e2e-comprehensive:
    name: E2E Comprehensive - ${{ matrix.project }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        project: ['Desktop Chrome', 'Desktop Firefox', 'iPhone 12 Portrait', 'iPad Pro 11 Portrait']
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: dist/
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium webkit firefox
      - name: Set project slug
        id: slug
        run: |
          PROJECT_SLUG=$(echo "${{ matrix.project }}" | sed 's/ /-/g')
          echo "project_slug=${PROJECT_SLUG}" >> $GITHUB_OUTPUT
      - name: Run E2E comprehensive tests
        run: pnpm exec playwright test --project="${{ matrix.project }}" --workers=1 --reporter=junit,line
        env:
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: junit-${{ steps.slug.outputs.project_slug }}.xml
      - name: Upload JUnit test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-comprehensive-junit-${{ steps.slug.outputs.project_slug }}
          path: junit-${{ steps.slug.outputs.project_slug }}.xml
          retention-days: 7
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: e2e-comprehensive-reports-${{ steps.slug.outputs.project_slug }}
          path: playwright-report/
          retention-days: 7

  e2e-comprehensive-collector:
    name: E2E Comprehensive - Collector
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [e2e-comprehensive]
    steps:
      - name: Download all JUnit artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: e2e-comprehensive-junit-*
          path: junit-results/
          merge-multiple: true
      - name: Combine JUnit reports
        run: |
          mkdir -p combined-junit
          # Check if any XML files exist
          if [ -d "junit-results" ] && compgen -G "junit-results/*.xml" > /dev/null; then
            echo '<?xml version="1.0" encoding="UTF-8"?>' > combined-junit/junit-combined.xml
            echo '<testsuites>' >> combined-junit/junit-combined.xml
            for file in junit-results/*.xml; do
              # Extract testsuite elements (skip XML declaration and testsuites wrapper)
              sed -n '/<testsuite[> ]/,/<\/testsuite>/p' "$file" >> combined-junit/junit-combined.xml
            done
            echo '</testsuites>' >> combined-junit/junit-combined.xml
            echo "‚úÖ Combined JUnit reports successfully"
            echo "Reports found:"
            ls -la junit-results/
          else
            echo "‚ö†Ô∏è No JUnit reports found to combine"
          fi
      - name: Upload combined JUnit results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-comprehensive-junit-combined
          path: combined-junit/
          retention-days: 7
      - name: Check E2E comprehensive results
        run: |
          echo "E2E Comprehensive Test Results:"
          echo "Matrix job result: ${{ needs.e2e-comprehensive.result }}"
          
          # Check if any matrix job failed
          if [[ "${{ needs.e2e-comprehensive.result }}" == "failure" ]]; then
            echo "‚ùå One or more E2E comprehensive tests failed"
            echo "Check individual matrix job results for details"
            exit 1
          elif [[ "${{ needs.e2e-comprehensive.result }}" == "cancelled" ]]; then
            echo "‚ö†Ô∏è E2E comprehensive tests were cancelled"
            exit 1
          fi
          
          echo "‚úÖ All E2E comprehensive matrix tests passed"

  # Collector job that ensures all checks pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, typecheck, unit, build, e2e-smoke, e2e-comprehensive-collector]
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "‚ùå Lint failed"
            exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "‚ùå Type check failed"
            exit 1
          fi
          if [[ "${{ needs.unit.result }}" != "success" ]]; then
            echo "‚ùå Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          # E2E smoke runs on PRs, comprehensive runs on main pushes
          if [[ "${{ needs.e2e-smoke.result }}" != "success" && "${{ needs.e2e-smoke.result }}" != "skipped" ]]; then
            echo "‚ùå E2E smoke tests failed"
            exit 1
          fi
          if [[ "${{ needs.e2e-comprehensive-collector.result }}" != "success" && "${{ needs.e2e-comprehensive-collector.result }}" != "skipped" ]]; then
            echo "‚ùå E2E comprehensive tests failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed"

  # Post PR comment with CI results
  pr-comment:
    name: Update PR with CI Results
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [lint, typecheck, unit, build, e2e-smoke, ci-success]
    permissions:
      pull-requests: write
    steps:
      - name: Generate CI summary
        id: summary
        run: |
          # Determine overall status
          if [[ "${{ needs.ci-success.result }}" == "success" ]]; then
            STATUS="‚úÖ **CI Passed**"
            EMOJI="üéâ"
          else
            STATUS="‚ùå **CI Failed**"
            EMOJI="‚ö†Ô∏è"
          fi
          
          # Build detailed results
          cat << EOF > summary.md
          ## ${EMOJI} CI Results for PR #${{ github.event.pull_request.number }}
          
          ${STATUS}
          
          ### Job Results
          | Job | Status |
          |-----|--------|
          | Lint | ${{ (needs.lint.result == 'success' && '‚úÖ Passed') || (needs.lint.result == 'skipped' && '‚è≠Ô∏è Skipped') || (needs.lint.result == 'cancelled' && 'üö´ Cancelled') || '‚ùå Failed' }} |
          | Type Check | ${{ (needs.typecheck.result == 'success' && '‚úÖ Passed') || (needs.typecheck.result == 'skipped' && '‚è≠Ô∏è Skipped') || (needs.typecheck.result == 'cancelled' && 'üö´ Cancelled') || '‚ùå Failed' }} |
          | Unit Tests | ${{ (needs.unit.result == 'success' && '‚úÖ Passed') || (needs.unit.result == 'skipped' && '‚è≠Ô∏è Skipped') || (needs.unit.result == 'cancelled' && 'üö´ Cancelled') || '‚ùå Failed' }} |
          | Build | ${{ (needs.build.result == 'success' && '‚úÖ Passed') || (needs.build.result == 'skipped' && '‚è≠Ô∏è Skipped') || (needs.build.result == 'cancelled' && 'üö´ Cancelled') || '‚ùå Failed' }} |
          | E2E Smoke Tests | ${{ (needs.e2e-smoke.result == 'success' && '‚úÖ Passed') || (needs.e2e-smoke.result == 'skipped' && '‚è≠Ô∏è Skipped') || (needs.e2e-smoke.result == 'cancelled' && 'üö´ Cancelled') || '‚ùå Failed' }} |
          
          ### Quick Actions
          EOF
          
          # Add failure-specific guidance
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "- üîß Run \`pnpm lint:fix\` to auto-fix linting issues" >> summary.md
          fi
          
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "- üîç Run \`pnpm exec tsc --noEmit\` to check types locally" >> summary.md
          fi
          
          if [[ "${{ needs.unit.result }}" != "success" ]]; then
            echo "- üß™ Run \`pnpm test\` to reproduce unit test failures" >> summary.md
          fi
          
          if [[ "${{ needs.e2e-smoke.result }}" == "failure" ]]; then
            echo "- üé≠ Run \`pnpm exec playwright test --project=\"Desktop Chrome\"\` to debug E2E tests" >> summary.md
          fi
          
          if [[ "${{ needs.ci-success.result }}" == "success" ]]; then
            cat << EOF >> summary.md
          
          ---
          _This PR is ready for review! All checks have passed._
          EOF
          else
            cat << EOF >> summary.md
          
          ---
          _Please fix the failing checks before requesting review._
          EOF
          fi
          
          echo "summary_file=summary.md" >> $GITHUB_OUTPUT

      - name: Post or update PR comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CI Results for PR')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
              console.log('Updated existing PR comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
              console.log('Created new PR comment');
            }

  # Wait for SonarCloud and post detailed results
  sonarcloud-report:
    name: SonarCloud Analysis Report
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [ci-success]
    permissions:
      pull-requests: write
    steps:
      - name: Wait for SonarCloud Analysis
        id: wait-sonar
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          script: |
            const maxAttempts = 30;
            const delayMs = 10000; // 10 seconds
            
            async function sleep(ms) {
              return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // Wait for SonarCloud to complete analysis
            console.log('Waiting for SonarCloud analysis to complete...');
            await sleep(30000); // Initial wait of 30 seconds
            
            const sonarToken = process.env.SONAR_TOKEN;
            if (!sonarToken) {
              console.log('‚ö†Ô∏è SONAR_TOKEN not available, skipping SonarCloud report');
              return { skipped: true };
            }
            
            const projectKey = 'arcade-cabinet_psyduck-panic';
            const baseUrl = 'https://sonarcloud.io/api';
            
            // Get the PR key for SonarCloud
            const prKey = context.payload.pull_request.number;
            
            // Try to get analysis results
            let analysisFound = false;
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              try {
                const response = await fetch(
                  `${baseUrl}/measures/component?component=${projectKey}&pullRequest=${prKey}&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots`,
                  {
                    headers: {
                      'Authorization': `Bearer ${sonarToken}`
                    }
                  }
                );
                
                if (response.ok) {
                  const data = await response.json();
                  analysisFound = true;
                  console.log('‚úÖ SonarCloud analysis found');
                  return { found: true, data: data };
                }
                
                console.log(`Attempt ${attempt}/${maxAttempts}: Analysis not ready yet...`);
                await sleep(delayMs);
              } catch (error) {
                console.log(`Attempt ${attempt}/${maxAttempts}: Error checking SonarCloud: ${error.message}`);
                await sleep(delayMs);
              }
            }
            
            console.log('‚ö†Ô∏è SonarCloud analysis not found after waiting');
            return { found: false };

      - name: Get SonarCloud Issues
        id: get-issues
        if: fromJSON(steps.wait-sonar.outputs.result).found == true
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          script: |
            const sonarToken = process.env.SONAR_TOKEN;
            const projectKey = 'arcade-cabinet_psyduck-panic';
            const baseUrl = 'https://sonarcloud.io/api';
            const prKey = context.payload.pull_request.number;
            
            // Get issues for this PR
            try {
              const issuesResponse = await fetch(
                `${baseUrl}/issues/search?componentKeys=${projectKey}&pullRequest=${prKey}&resolved=false&ps=100`,
                {
                  headers: {
                    'Authorization': `Bearer ${sonarToken}`
                  }
                }
              );
              
              if (!issuesResponse.ok) {
                console.log('Failed to fetch issues from SonarCloud');
                return { issues: [] };
              }
              
              const issuesData = await issuesResponse.json();
              return { issues: issuesData.issues || [] };
            } catch (error) {
              console.log(`Error fetching issues: ${error.message}`);
              return { issues: [] };
            }

      - name: Post SonarCloud Report to PR
        if: fromJSON(steps.wait-sonar.outputs.result).found == true
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const waitResult = ${{ steps.wait-sonar.outputs.result }};
            const issuesResult = ${{ steps.get-issues.outputs.result }};
            
            if (waitResult.skipped) {
              console.log('Skipped due to missing SONAR_TOKEN');
              return;
            }
            
            if (!waitResult.found) {
              console.log('SonarCloud analysis not found');
              return;
            }
            
            const measures = waitResult.data?.component?.measures || [];
            const issues = issuesResult.issues || [];
            
            // Parse measures
            const metricsMap = {};
            measures.forEach(m => {
              metricsMap[m.metric] = m.value;
            });
            
            const bugs = metricsMap.bugs || '0';
            const vulnerabilities = metricsMap.vulnerabilities || '0';
            const codeSmells = metricsMap.code_smells || '0';
            const coverage = metricsMap.coverage || 'N/A';
            const duplications = metricsMap.duplicated_lines_density || 'N/A';
            const hotspots = metricsMap.security_hotspots || '0';
            
            // Build report
            const projectKey = 'arcade-cabinet_psyduck-panic';
            const prKey = context.payload.pull_request.number;
            const sonarUrl = `https://sonarcloud.io/summary/overall?id=${projectKey}&pullRequest=${prKey}`;
            
            let report = `<!-- sonarcloud-report-comment -->\n`;
            report += `## üîç SonarCloud Analysis Results\n\n`;
            report += `### Summary\n`;
            report += `| Metric | Value |\n`;
            report += `|--------|-------|\n`;
            report += `| üêõ Bugs | ${bugs} |\n`;
            report += `| üîí Vulnerabilities | ${vulnerabilities} |\n`;
            report += `| üî• Security Hotspots | ${hotspots} |\n`;
            report += `| üí© Code Smells | ${codeSmells} |\n`;
            report += `| üìä Coverage | ${coverage}${coverage !== 'N/A' ? '%' : ''} |\n`;
            report += `| üìã Duplications | ${duplications}${duplications !== 'N/A' ? '%' : ''} |\n\n`;
            
            // Add issues if any
            if (issues.length > 0) {
              report += `### üö® Issues Found (${issues.length})\n\n`;
              
              const criticalIssues = issues.filter(i => i.severity === 'CRITICAL' || i.severity === 'BLOCKER');
              const majorIssues = issues.filter(i => i.severity === 'MAJOR');
              const minorIssues = issues.filter(i => i.severity === 'MINOR' || i.severity === 'INFO');
              
              if (criticalIssues.length > 0) {
                report += `#### üî¥ Critical/Blocker Issues (${criticalIssues.length})\n`;
                criticalIssues.slice(0, 10).forEach(issue => {
                  report += `- **${issue.message}** (${issue.type})\n`;
                  report += `  - File: \`${issue.component.split(':')[1] || issue.component}\``;
                  if (issue.line) report += ` Line ${issue.line}`;
                  report += `\n`;
                });
                if (criticalIssues.length > 10) {
                  report += `_...and ${criticalIssues.length - 10} more critical issues_\n`;
                }
                report += `\n`;
              }
              
              if (majorIssues.length > 0) {
                report += `#### üü° Major Issues (${majorIssues.length})\n`;
                majorIssues.slice(0, 5).forEach(issue => {
                  report += `- ${issue.message} (${issue.type})\n`;
                  report += `  - File: \`${issue.component.split(':')[1] || issue.component}\``;
                  if (issue.line) report += ` Line ${issue.line}`;
                  report += `\n`;
                });
                if (majorIssues.length > 5) {
                  report += `_...and ${majorIssues.length - 5} more major issues_\n`;
                }
                report += `\n`;
              }
              
              if (minorIssues.length > 0) {
                report += `#### ‚ÑπÔ∏è Minor/Info Issues (${minorIssues.length})\n`;
                report += `_View all minor issues in the [SonarCloud dashboard](${sonarUrl})_\n\n`;
              }
            } else {
              report += `### ‚úÖ No Issues Found\n\n`;
              report += `Great job! SonarCloud didn't find any issues in this PR.\n\n`;
            }
            
            report += `---\n`;
            report += `[üìä View Full Analysis on SonarCloud](${sonarUrl})\n`;
            
            // Find existing SonarCloud comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const sonarComment = comments.find(comment => 
              comment.body && comment.body.includes('<!-- sonarcloud-report-comment -->')
            );
            
            if (sonarComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: sonarComment.id,
                body: report
              });
              console.log('Updated existing SonarCloud comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('Created new SonarCloud comment');
            }
