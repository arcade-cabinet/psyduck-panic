name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: read

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Lint
        run: pnpm lint

      - name: Type Check
        run: pnpm exec tsc --noEmit

      - name: Unit Tests
        run: pnpm test

      - name: Build
        run: pnpm build

  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps
      - name: Run E2E (headed via xvfb)
        run: xvfb-run --auto-servernum pnpm exec playwright test --workers=1
        env:
          CI: "true"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-reports
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  security:
    name: Security & Code Analysis
    runs-on: ubuntu-latest
    needs: [code-quality]
    # Security scans are best-effort — don't block CI if secrets are missing
    continue-on-error: true
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          build-mode: none
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        uses: sonarsource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, security, e2e-smoke]
    steps:
      - name: Check CI status
        run: |
          echo "code-quality: ${{ needs.code-quality.result }}"
          echo "security: ${{ needs.security.result }}"
          echo "e2e-smoke: ${{ needs.e2e-smoke.result }}"
          if [[ "${{ needs.code-quality.result }}" != "success" ]]; then exit 1; fi
          # Security is best-effort — allow success or failure
          if [[ "${{ needs.e2e-smoke.result }}" != "success" ]]; then exit 1; fi
          echo "All CI checks passed"
