name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm exec tsc --noEmit

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:coverage
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: unit-test-reports
          path: coverage/
          retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: dist/
          retention-days: 1

  e2e-smoke:
    name: E2E Smoke Tests - Desktop Chrome
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: dist/
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
      - name: Run E2E smoke tests
        run: pnpm exec playwright test --project="Desktop Chrome" --workers=1
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: e2e-smoke-reports
          path: playwright-report/
          retention-days: 7

  e2e-comprehensive:
    name: E2E Comprehensive - ${{ matrix.project }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        project: ['Desktop Chrome', 'Desktop Firefox', 'iPhone 12 Portrait', 'iPad Pro 11 Portrait']
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: dist
          path: dist/
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium webkit firefox
      - name: Run E2E comprehensive tests
        run: pnpm exec playwright test --project="${{ matrix.project }}" --workers=1 --reporter=junit,line
        env:
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: junit-${{ matrix.project }}.xml
      - name: Upload JUnit test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-comprehensive-junit-${{ matrix.project }}
          path: junit-${{ matrix.project }}.xml
          retention-days: 7
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: failure()
        with:
          name: e2e-comprehensive-reports-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

  e2e-comprehensive-collector:
    name: E2E Comprehensive - Collector
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [e2e-comprehensive]
    steps:
      - name: Download all JUnit artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: e2e-comprehensive-junit-*
          path: junit-results/
          merge-multiple: true
      - name: Combine JUnit reports
        run: |
          mkdir -p combined-junit
          if [ -d "junit-results" ] && [ "$(ls -A junit-results/*.xml 2>/dev/null)" ]; then
            cat junit-results/*.xml > combined-junit/junit-combined.xml
            echo "✅ Combined JUnit reports successfully"
            echo "Reports found:"
            ls -la junit-results/
          else
            echo "⚠️ No JUnit reports found to combine"
          fi
      - name: Upload combined JUnit results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-comprehensive-junit-combined
          path: combined-junit/
          retention-days: 7
      - name: Check E2E comprehensive results
        run: |
          echo "E2E Comprehensive Test Results:"
          echo "Desktop Chrome: ${{ needs.e2e-comprehensive.result }}"
          if [[ "${{ needs.e2e-comprehensive.result }}" == "failure" ]]; then
            echo "❌ E2E comprehensive tests failed"
            exit 1
          fi
          echo "✅ All E2E comprehensive tests passed"

  # Collector job that ensures all checks pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [lint, typecheck, unit, build, e2e-smoke, e2e-comprehensive-collector]
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "❌ Lint failed"
            exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "❌ Type check failed"
            exit 1
          fi
          if [[ "${{ needs.unit.result }}" != "success" ]]; then
            echo "❌ Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ Build failed"
            exit 1
          fi
          # E2E smoke runs on PRs, comprehensive runs on main pushes
          if [[ "${{ needs.e2e-smoke.result }}" != "success" && "${{ needs.e2e-smoke.result }}" != "skipped" ]]; then
            echo "❌ E2E smoke tests failed"
            exit 1
          fi
          if [[ "${{ needs.e2e-comprehensive-collector.result }}" != "success" && "${{ needs.e2e-comprehensive-collector.result }}" != "skipped" ]]; then
            echo "❌ E2E comprehensive tests failed"
            exit 1
          fi
          echo "✅ All CI checks passed"
