name: CI - Fast Quality Checks

on:
  pull_request:
    branches: [main]
  workflow_call: # Allow CD to call this workflow
    inputs:
      skip-e2e:
        description: 'Skip E2E smoke tests'
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      skip-e2e:
        description: 'Skip E2E smoke tests'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # Parallel quality checks: lint, typecheck, and unit tests
  # These run first as they're fast and catch most issues
  quality-checks:
    name: ${{ matrix.check }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        check: ['lint', 'typecheck', 'test']
    permissions:
      contents: read
    steps:
      # Checkout repository
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      # Setup Node.js environment with pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      
      # Install dependencies once, cached by pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Run the specific check for this matrix job
      - name: Run ${{ matrix.check }}
        run: |
          case "${{ matrix.check }}" in
            lint)
              pnpm lint
              ;;
            typecheck)
              pnpm exec tsc --noEmit
              ;;
            test)
              pnpm test:coverage
              ;;
          esac

  # Quick smoke test: Only 3 core devices for fast feedback on PRs
  # Skipped if skip-e2e input is true or DISABLE_E2E_SMOKE variable is set
  e2e-smoke:
    name: E2E Smoke - ${{ matrix.device }}
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [quality-checks]
    if: ${{ !(inputs.skip-e2e == true || vars.DISABLE_E2E_SMOKE == 'true') }}
    strategy:
      fail-fast: false
      matrix:
        device: ['Desktop Chrome', 'iPhone 12 Portrait', 'iPad Pro 11 Portrait']
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      # Setup Node.js environment with pnpm and caching
      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js with cache
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      
      # Install dependencies (cached by setup-node)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Install only Chromium browser for smoke tests (faster than all browsers)
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium
      
      # Build project once for all E2E tests
      - name: Build project
        run: pnpm build
      
      # Run E2E test for this device
      - name: Run Playwright tests on ${{ matrix.device }}
        run: pnpm exec playwright test --project="${{ matrix.device }}"
      
      # Upload test results only on failure to save storage
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-smoke-${{ matrix.device }}-report
          path: playwright-report/
          retention-days: 3

  # Build job - runs in parallel with e2e-smoke after quality checks pass
  # This allows faster feedback if e2e tests are skipped
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-checks]
    if: always() && needs.quality-checks.result == 'success'
    permissions:
      contents: read
    steps:
      # Checkout repository
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      
      # Setup Node.js environment with pnpm and caching
      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js with cache
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
      
      # Install dependencies (cached by setup-node)
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Build project to verify production build works
      - name: Build project
        run: pnpm build
      
      # Upload build artifacts for potential use in downstream jobs
      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: dist/
          retention-days: 1

  # Collector job that waits for all CI checks to complete
  # Used by automerge workflow to ensure all checks pass before merging
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-checks, e2e-smoke, build]
    steps:
      - name: Check CI status
        run: |
          # Check if all required jobs succeeded
          if [[ "${{ needs.quality-checks.result }}" != "success" ]]; then
            echo "❌ Quality checks failed"
            exit 1
          fi
          
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "❌ Build failed"
            exit 1
          fi
          
          # E2E smoke tests can be skipped, so check for success or skipped
          if [[ "${{ needs.e2e-smoke.result }}" != "success" && "${{ needs.e2e-smoke.result }}" != "skipped" ]]; then
            echo "❌ E2E smoke tests failed"
            exit 1
          fi
          
          echo "✅ All CI checks passed"

