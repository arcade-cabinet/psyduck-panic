name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:

permissions:
  contents: read

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup

      - name: Lint
        run: pnpm lint

      - name: Type Check
        run: pnpm exec tsc --noEmit

      - name: Unit Tests
        run: pnpm test

      - name: Build
        run: pnpm build

  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup
      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps
      - name: Run E2E (headed via xvfb)
        run: pnpm test:e2e
        env:
          CI: "true"
      - uses: actions/upload-artifact@47309c993abb98030a35d55ef7ff34b7fa1074b5 # v6.0.0
        if: always()
        with:
          name: e2e-reports
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  security:
    name: Security & Code Analysis
    runs-on: ubuntu-latest
    needs: [code-quality]
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
      - name: Generate Test Coverage
        run: pnpm run test:coverage
      - name: Verify Coverage Report
        run: |
          if [ ! -f coverage/lcov.info ]; then
            echo "Error: coverage/lcov.info not found"
            exit 1
          fi
          echo "Coverage report found at coverage/lcov.info"
          ls -lh coverage/
      - name: Initialize CodeQL
        uses: github/codeql-action/init@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          languages: javascript-typescript
          build-mode: none
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        uses: sonarsource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, security, e2e-smoke]
    steps:
      - name: Check CI status
        run: |
          echo "code-quality: ${{ needs.code-quality.result }}"
          echo "security: ${{ needs.security.result }}"
          echo "e2e-smoke: ${{ needs.e2e-smoke.result }}"
          if [[ "${{ needs.code-quality.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.security.result }}" == "failure" ]]; then echo "Security failed (non-blocking)"; fi
          if [[ "${{ needs.e2e-smoke.result }}" != "success" ]]; then exit 1; fi
          echo "All CI checks passed"
