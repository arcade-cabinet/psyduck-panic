name: CI

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:

permissions:
  contents: read

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup

      - name: Lint (Biome)
        run: pnpm lint

      - name: Check Babylon.js Imports (Tree-Shakable Only)
        run: pnpm check-imports

      - name: Type Check
        run: pnpm exec tsc --noEmit

      - name: Unit Tests (Jest)
        run: pnpm test

  web-build:
    name: Web Build
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup

      - name: Build Expo Web (Production)
        run: pnpm build:web

      - name: Generate Bundle Analysis
        run: pnpm analyze-bundle

      - name: Upload Bundle Analysis
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: bundle-analysis
          path: bundle-analysis.html
          retention-days: 30

      - name: Verify Bundle Size (< 5 MB gzipped)
        run: |
          RAW_SIZE=$(find dist -name "*.js" -print0 | xargs -0 cat | wc -c)
          GZIP_SIZE=$(find dist -name "*.js" -print0 | xargs -0 cat | gzip -c | wc -c)
          echo "Total JS raw size: ${RAW_SIZE} bytes"
          echo "Total JS gzipped size: ${GZIP_SIZE} bytes"
          if [ ${GZIP_SIZE} -ge 5242880 ]; then
            echo "Error: Total gzipped JS bundle size (${GZIP_SIZE} bytes) exceeds 5 MB limit"
            exit 1
          fi
          echo "Bundle size check passed (${GZIP_SIZE} bytes gzipped)"

  android-build:
    name: Android Build
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ hashFiles('android/**/*.gradle*', 'android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Build Debug APK
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon

  web-e2e:
    name: Web E2E (Playwright)
    runs-on: ubuntu-latest
    needs: [web-build]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Run Playwright E2E (Expo web)
        run: pnpm test:e2e:web
        env:
          CI: "true"

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: playwright-reports
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  mobile-e2e:
    name: Mobile E2E (Maestro)
    runs-on: macos-latest
    needs: [android-build]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/setup

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ hashFiles('android/**/*.gradle*', 'android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Build Debug APK
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          script: echo "Emulator started"

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      - name: Install Debug APK
        run: adb install android/app/build/outputs/apk/debug/app-debug.apk

      - name: Run Maestro E2E Flows
        run: maestro test .maestro/

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: maestro-reports
          path: |
            .maestro/reports/
          retention-days: 7

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, web-build, android-build, web-e2e, mobile-e2e]
    steps:
      - name: Check CI status
        run: |
          echo "code-quality: ${{ needs.code-quality.result }}"
          echo "web-build: ${{ needs.web-build.result }}"
          echo "android-build: ${{ needs.android-build.result }}"
          echo "web-e2e: ${{ needs.web-e2e.result }}"
          echo "mobile-e2e: ${{ needs.mobile-e2e.result }}"
          if [[ "${{ needs.code-quality.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.web-build.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.android-build.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.web-e2e.result }}" != "success" ]]; then exit 1; fi
          if [[ "${{ needs.mobile-e2e.result }}" != "success" ]]; then exit 1; fi
          echo "All CI checks passed"
