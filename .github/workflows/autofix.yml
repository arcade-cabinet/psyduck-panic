name: Auto-Fix Workflow Failures

on:
  workflow_run:
    workflows: ["CI", "CD"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  fix-failure:
    name: Auto-Fix Workflow Failure
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      - name: Invoke Jules for Auto-Fix
        uses: google-labs-code/jules-action@bff7875eaa123cac6742b7cfc51005b95ba4d566 # v1.0.0
        with:
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          prompt: |
            The "${{ github.event.workflow_run.name }}" workflow failed on branch ${{ github.event.workflow_run.head_branch }}.
            
            Analyze the failure and apply a comprehensive, brand and vision aligned solution:
            1. Review job logs, test reports, and artifacts
            2. Identify root causes (lint errors, type issues, test failures, build errors, deployment issues)
            3. Apply targeted fixes to code, configs, dependencies, or workflow files
            4. Verify fixes work by running checks locally
            5. Review documentation for context
            
            Focus on automated fixes that don't require human judgment.
            Be thorough in analyzing all failed jobs and their logs.
