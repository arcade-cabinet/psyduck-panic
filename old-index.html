<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Psyduck Panic: Evolution Deluxe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #020208;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-scaler { position: relative; transform-origin: center center; }

        #game-container {
            width: 800px; height: 600px;
            background: #0a0a18;
            position: relative;
            overflow: hidden;
            border: 3px solid #1a1a3a;
        }

        /* CRT scanlines */
        #game-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px);
            pointer-events: none;
            z-index: 55;
        }

        /* Vignette */
        #game-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: inset 0 0 120px rgba(0,0,0,0.7), inset 0 0 40px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 56;
            animation: rgbBorder 6s infinite;
        }

        @keyframes rgbBorder {
            0% { border: 2px solid rgba(0,255,255,0.25); }
            33% { border: 2px solid rgba(255,0,255,0.25); }
            66% { border: 2px solid rgba(255,255,0,0.25); }
            100% { border: 2px solid rgba(0,255,255,0.25); }
        }

        canvas { display: block; }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 60;
        }

        .hud-top {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 10px 14px;
            color: white;
            text-shadow: 0 0 8px rgba(0,0,0,0.9), 2px 2px 0 #000;
            font-size: 9px;
        }
        .hud-left { display: flex; flex-direction: column; gap: 5px; }
        .hud-right { text-align: right; display: flex; flex-direction: column; gap: 3px; line-height: 1.7; }
        .hud-center { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; }

        .meter-container {
            width: 200px; height: 16px;
            background: #111; border: 2px solid #333;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.5), inset 0 2px 4px rgba(0,0,0,0.8);
            border-radius: 2px; overflow: hidden;
        }
        #panic-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f1c40f 50%, #e74c3c);
            transition: width 0.15s ease-out;
        }
        #panic-bar::after {
            content: ''; position: absolute; top:0;left:0;right:0;bottom:0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 50%, rgba(0,0,0,0.2) 100%);
        }
        .marker { position: absolute; top:0;bottom:0;width:2px; background: rgba(255,255,255,0.25); z-index:2; }

        #combo-display { color: #f1c40f; font-size: 9px; margin-top: 3px; transition: all 0.15s; text-shadow: 0 0 10px rgba(241,196,15,0.5); }
        #wave-display { color: #00ffff; font-size: 9px; text-shadow: 0 0 15px rgba(0,255,255,0.5); }

        /* Boss HP bar */
        #boss-hp-container {
            position: absolute; top: 46px; left: 50%; transform: translateX(-50%);
            width: 300px; z-index: 70; pointer-events: none;
            text-align: center; display: none;
        }
        #boss-hp-container .boss-name { color: #e74c3c; font-size: 8px; margin-bottom: 4px; text-shadow: 0 0 10px rgba(231,76,60,0.5); }
        #boss-hp-outer { width: 100%; height: 10px; background: #111; border: 2px solid #e74c3c; border-radius: 2px; overflow: hidden; }
        #boss-hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #e74c3c, #f39c12); transition: width 0.2s; }

        /* Hype Feed */
        #hype-feed {
            position: absolute;
            right: 0; top: 40px; width: 170px; bottom: 75px;
            overflow: hidden;
            pointer-events: none;
            z-index: 58;
            mask-image: linear-gradient(180deg, transparent 0%, black 10%, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(180deg, transparent 0%, black 10%, black 90%, transparent 100%);
        }
        .feed-item {
            background: rgba(10,10,30,0.75);
            border-left: 2px solid rgba(100,100,255,0.2);
            padding: 6px 8px;
            margin: 3px 6px;
            font-size: 6px;
            color: #556;
            line-height: 1.6;
            border-radius: 3px;
            animation: feedScroll 18s linear forwards;
            position: relative;
        }
        .feed-item .feed-user { color: #779; margin-bottom: 2px; }
        .feed-item .feed-engagement { color: #445; margin-top: 3px; font-size: 5px; }
        @keyframes feedScroll {
            0% { transform: translateY(0); opacity: 0.6; }
            5% { opacity: 0.6; }
            90% { opacity: 0.4; }
            100% { transform: translateY(-500px); opacity: 0; }
        }

        /* Controls */
        #controls {
            display: flex; justify-content: center; gap: 6px;
            padding: 8px 10px;
            background: linear-gradient(180deg, rgba(10,10,24,0.95), rgba(5,5,15,0.98));
            pointer-events: auto;
            border-top: 1px solid rgba(255,255,255,0.04);
        }
        .btn {
            border: none;
            border-bottom: 4px solid rgba(0,0,0,0.4);
            color: white; padding: 10px 4px;
            font-family: 'Press Start 2P', cursive; font-size: 8px;
            cursor: pointer; width: 23%; text-align: center;
            transition: all 0.08s; user-select: none;
            position: relative; border-radius: 4px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }
        .btn:active, .btn.pressed { transform: translateY(4px); border-bottom-width: 0; filter: brightness(0.85); }
        .btn span { display: block; font-size: 6px; margin-top: 4px; opacity: 0.6; line-height: 1.3; }
        .btn.reality { background: linear-gradient(180deg, #e67e22, #d35400); }
        .btn.history { background: linear-gradient(180deg, #2ecc71, #27ae60); }
        .btn.logic { background: linear-gradient(180deg, #9b59b6, #8e44ad); }
        .btn.special { background: linear-gradient(180deg, #e74c3c, #c0392b); }
        .btn.on-cooldown { filter: grayscale(0.8) brightness(0.4); pointer-events: none; }
        .key-hint {
            position: absolute; top: -7px; right: -3px;
            background: #fff; color: #000; padding: 2px 4px; font-size: 7px;
            border-radius: 3px; border: 1px solid #000;
        }
        .cooldown-bar { position: absolute; bottom:0;left:0; height: 3px; background: rgba(255,255,255,0.5); border-radius: 0 0 4px 4px; transition: width 0.1s linear; }

        /* Overlays */
        #overlay {
            position: absolute; top:0;left:0;width:100%;height:100%;
            background: rgba(5,5,15,0.97);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; z-index: 100; color: white;
        }
        #overlay h1 {
            color: #f1c40f; margin-bottom: 6px; line-height: 1.6;
            text-shadow: 4px 4px 0 #c0392b, 0 0 40px rgba(241,196,15,0.3);
            font-size: 22px; animation: titleFloat 3s ease-in-out infinite;
        }
        @keyframes titleFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        #overlay .subtitle { color: #00ffff; font-size: 9px; margin-bottom: 20px; text-shadow: 0 0 20px rgba(0,255,255,0.4); letter-spacing: 5px; }
        #overlay p { margin-bottom: 20px; font-size: 9px; line-height: 2.2; max-width: 560px; color: #888; }
        .start-btn {
            padding: 14px 32px; font-size: 13px;
            background: linear-gradient(180deg, #e74c3c, #c0392b);
            border: 3px solid #fff; color: white;
            font-family: 'Press Start 2P', cursive; cursor: pointer;
            box-shadow: 0 6px 0 #7b241c, 0 0 30px rgba(231,76,60,0.3);
            transition: all 0.1s; animation: pulse 1.5s infinite; border-radius: 4px;
        }
        .start-btn:active { transform: translateY(6px); box-shadow: none; }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }
        .hidden { display: none !important; }

        /* Wave announce */
        #wave-announce {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            z-index: 90; text-align: center; pointer-events: none; opacity: 0;
        }
        #wave-announce .wt { font-size: 26px; color: #00ffff; text-shadow: 0 0 30px rgba(0,255,255,0.6), 3px 3px 0 #000; }
        #wave-announce .ws { font-size: 9px; color: #fff; margin-top: 8px; text-shadow: 2px 2px 0 #000; }
        #wave-announce.show { animation: waveAnn 2.5s ease-out forwards; }
        @keyframes waveAnn {
            0%{opacity:0;transform:translate(-50%,-50%) scale(2)}
            15%{opacity:1;transform:translate(-50%,-50%) scale(1)}
            75%{opacity:1;transform:translate(-50%,-50%) scale(1)}
            100%{opacity:0;transform:translate(-50%,-50%) scale(0.8)}
        }

        .damage-text {
            position: absolute; font-weight: bold; font-size: 13px; pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 2px 2px 0 #000, 0 0 10px rgba(0,0,0,0.8);
            z-index: 80; font-family: 'Press Start 2P', cursive;
        }
        @keyframes floatUp { 0%{opacity:1;transform:translateY(0) scale(1)} 50%{opacity:1;transform:translateY(-20px) scale(1.1)} 100%{opacity:0;transform:translateY(-50px) scale(0.8)} }
        .powerup-text { font-size: 11px; animation: puFloat 1.5s forwards; }
        @keyframes puFloat { 0%{opacity:0;transform:translateY(0) scale(0.5)} 20%{opacity:1;transform:translateY(-10px) scale(1.2)} 80%{opacity:1;transform:translateY(-30px) scale(1)} 100%{opacity:0;transform:translateY(-50px) scale(0.8)} }

        .stat-row { display:flex; justify-content:space-between; width:320px; margin:5px auto; font-size:8px; border-bottom:1px solid rgba(255,255,255,0.08); padding:5px 0; }
        .stat-label { color: #666; }
        .stat-value { color: #f1c40f; }
        .grade { font-size: 48px; margin: 12px 0 6px; }
        .grade-s { color: #f1c40f; text-shadow: 0 0 30px rgba(241,196,15,0.6); animation: gradeShine 1s infinite; }
        .grade-a { color: #2ecc71; text-shadow: 0 0 20px rgba(46,204,113,0.4); }
        .grade-b { color: #3498db; }
        .grade-c { color: #e67e22; }
        .grade-d { color: #e74c3c; }
        @keyframes gradeShine { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.5)} }

        #powerup-hud {
            position: absolute; bottom: 76px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 70; pointer-events: none;
        }
        .pu-icon {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; border: 2px solid rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.7); opacity: 0; transition: all 0.3s;
        }
        .pu-icon.active { opacity: 1; animation: puBob 1s infinite; }
        @keyframes puBob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
    </style>
</head>
<body>
<div id="game-scaler">
    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="wave-announce"><div class="wt" id="wa-title"></div><div class="ws" id="wa-sub"></div></div>
        <div id="boss-hp-container">
            <div class="boss-name" id="boss-name">BOSS</div>
            <div id="boss-hp-outer"><div id="boss-hp-bar"></div></div>
        </div>
        <div id="hype-feed"></div>
        <div id="powerup-hud">
            <div class="pu-icon" id="pu-slow">‚è≥</div>
            <div class="pu-icon" id="pu-shield">üõ°Ô∏è</div>
            <div class="pu-icon" id="pu-double">‚≠ê</div>
        </div>
        <div id="ui-layer">
            <div class="hud-top">
                <div class="hud-left">
                    <div>PANIC</div>
                    <div class="meter-container">
                        <div class="marker" style="left:33%"></div>
                        <div class="marker" style="left:66%"></div>
                        <div id="panic-bar"></div>
                    </div>
                    <div id="combo-display">COMBO: x1</div>
                </div>
                <div class="hud-center"><div id="wave-display">WAVE 1</div></div>
                <div class="hud-right">
                    <div>TIME: <span id="time-display">30</span>s</div>
                    <div>SCORE: <span id="score-display">0</span></div>
                </div>
            </div>
            <div id="controls">
                <div class="btn reality" id="btn-reality"><div class="key-hint">1</div>REALITY<span>ü¶† HYPE</span><div class="cooldown-bar" id="cd-reality"></div></div>
                <div class="btn history" id="btn-history"><div class="key-hint">2</div>HISTORY<span>üìà GROWTH</span><div class="cooldown-bar" id="cd-history"></div></div>
                <div class="btn logic" id="btn-logic"><div class="key-hint">3</div>LOGIC<span>ü§ñ DEMOS</span><div class="cooldown-bar" id="cd-logic"></div></div>
                <div class="btn special" id="btn-special"><div class="key-hint">Q</div>NUKE<span>üí• ALL</span><div class="cooldown-bar" id="cd-special"></div></div>
            </div>
        </div>
        <div id="overlay">
            <h1 id="overlay-title">PSYDUCK PANIC<br>EVOLUTION</h1>
            <div class="subtitle">D E L U X E</div>
            <p id="overlay-desc">
                Your brother is doomscrolling AI hype.<br>
                Counter thought bubbles before PANIC hits 100%.<br>
                Survive 5 waves + bosses to save his brain.<br><br>
                <b style="color:#e67e22">1</b> Reality &nbsp; <b style="color:#2ecc71">2</b> History &nbsp; <b style="color:#9b59b6">3</b> Logic &nbsp; <b style="color:#e74c3c">Q</b> Nuke
            </p>
            <div id="end-stats" class="hidden"></div>
            <button class="start-btn" id="start-btn" onclick="startGame()">START DEBATE</button>
        </div>
    </div>
</div>


<script>
/**
 * Psyduck Panic: Evolution Deluxe ‚Äî Clean V2
 * Fixes:
 * - Boss X desync (visual vs logical)
 * - Splitter flood + child re-split
 * - Nuke boss multi-hit exploit
 * - Panic overflow + stacked panic hits (i-frames)
 * - Extra safety on music intervals
 * Additions:
 * - Cooldowns on 1/2/3 abilities + HUD bars
 * - Click/tap enemy to auto-counter (mobile-friendly)
 * - Momentum perks (combo-based micro buffs)
 * - Endless mode after Wave 5 victory (opt-in by continuing)
 */

function resizeGame(){
  const s=document.getElementById('game-scaler');
  const scale=(window.innerWidth/window.innerHeight)<(800/600)?window.innerWidth/800:window.innerHeight/600;
  s.style.transform=`scale(${scale})`;
}
window.addEventListener('resize',resizeGame);resizeGame();

const W=800,H=600;

const TYPES={
  REALITY:{words:["FEB 2020","VIRUS","PANDEMIC","HYPE TRAIN","VAPORWARE","TRUST ME","JUST WAIT"],color:"#e67e22",icon:"ü¶†",counter:"reality"},
  HISTORY:{words:["EXPONENTIAL","VERTICAL","SINGULARITY","MOORES LAW","10X","HOCKEY STICK","TO THE MOON"],color:"#2ecc71",icon:"üìà",counter:"history"},
  LOGIC:{words:["SNAKE DEMO","DEVIN","AGENTS","WRAPPER","GPT CAN","JUST PROMPT","ITS OVER"],color:"#9b59b6",icon:"ü§ñ",counter:"logic"}
};

const WAVES=[
  {name:"CASUAL SCROLLING",sub:"\"Just checking Twitter...\"",dur:28,spawn:1800,max:4,spd:1.0},
  {name:"RABBIT HOLE",sub:"\"Did you see this thread?\"",dur:26,spawn:1400,max:6,spd:1.15},
  {name:"DOOM LOOP",sub:"\"It's different this time!\"",dur:24,spawn:1050,max:8,spd:1.3,boss:{name:"THE HYPE TRAIN üöÇ",hp:12,pats:["burst","sweep"]}},
  {name:"FULL COPE",sub:"\"We're all gonna make it\"",dur:24,spawn:800,max:10,spd:1.5},
  {name:"FINAL FORM",sub:"\"I AM THE SINGULARITY\"",dur:35,spawn:550,max:14,spd:1.7,boss:{name:"THE SINGULARITY üß†",hp:20,pats:["burst","sweep","spiral"]}}
];

const POWERUPS=[
  {id:'slow',icon:'‚è≥',color:'#3498db',name:'TIME WARP',dur:5000},
  {id:'shield',icon:'üõ°Ô∏è',color:'#2ecc71',name:'CLARITY',dur:6000},
  {id:'double',icon:'‚≠ê',color:'#f1c40f',name:'2X SCORE',dur:8000},
];

const FEED=[
  ["@techbro42","Just saw GPT-7 write an entire OS in 3 seconds","‚ù§Ô∏è 4.2K"],
  ["@airesearcher","People aren't ready for what's coming next week","üîÅ 892"],
  ["@vccapital","Invested $400M in an AI wrapper. This changes everything.","‚ù§Ô∏è 12K"],
  ["@doomerpill","The last human programmer just lost their job","üí¨ 2.1K"],
  ["@founder_mode","My AI startup has no employees and $50M ARR","‚ù§Ô∏è 8.7K"],
  ["@siliconbrain","AGI by Tuesday. I'm not even joking.","üîÅ 3.3K"],
  ["@based_takes","Just replaced my entire team with Claude","‚ù§Ô∏è 15K"],
  ["@futurist99","Physical reality is just a UI for the simulation","üí¨ 445"],
  ["@gpumaxxer","Bought 10,000 H100s for my side project","‚ù§Ô∏è 2.8K"],
  ["@promptlord","10 AI tools that will make you mass extinct","üîÅ 6.1K"],
  ["@agi_when","We're 2 weeks away from 2 weeks away","‚ù§Ô∏è 1.4K"],
  ["@cryptoAI","What if we put AGI... on a blockchain?","üí¨ 987"],
  ["@scale_maxxer","If your training run costs less than $1B, not serious","‚ù§Ô∏è 5.5K"],
  ["@doomer_chad","Humans had a good run tbh","üîÅ 22K"],
  ["@lobotomy_corp","Our AI passed the bar, medical boards, AND a vibe check","‚ù§Ô∏è 9.1K"],
  ["@median_reply","This is just a Markov chain with good PR","üí¨ 67"],
];

// === AUDIO ===
class SFX {
  constructor(){this.ctx=null;this.bi=null;}
  init(){this.ctx=new(window.AudioContext||window.webkitAudioContext)();}
  resume(){if(this.ctx?.state==='suspended')this.ctx.resume();}
  tone(f,type='square',d=0.12,v=0.12){
    if(!this.ctx)return;
    const o=this.ctx.createOscillator(),g=this.ctx.createGain();
    o.type=type;o.frequency.setValueAtTime(f,this.ctx.currentTime);
    g.gain.setValueAtTime(v,this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+d);
    o.connect(g);g.connect(this.ctx.destination);o.start();o.stop(this.ctx.currentTime+d);
  }
  counter(c){
    const f=400+c*40;
    this.tone(f,'square',0.08,0.1);
    setTimeout(()=>this.tone(f*1.25,'square',0.08,0.08),50);
    setTimeout(()=>this.tone(f*1.5,'triangle',0.15,0.06),100);
  }
  miss(){this.tone(120,'sawtooth',0.2,0.08);}
  panicHit(){this.tone(90,'sawtooth',0.15,0.1);}
  powerup(){this.tone(600,'triangle',0.1,0.08);setTimeout(()=>this.tone(800,'triangle',0.1,0.08),80);setTimeout(()=>this.tone(1000,'triangle',0.2,0.06),160);}
  nuke(){this.tone(200,'sawtooth',0.4,0.13);setTimeout(()=>this.tone(100,'sawtooth',0.6,0.1),100);}
  bossHit(){this.tone(300,'square',0.06,0.1);this.tone(450,'square',0.06,0.08);}
  bossDie(){[0,80,160,240,320,400].forEach((d,i)=>setTimeout(()=>this.tone(200+i*80,'square',0.15,0.1),d));}
  waveStart(){[0,100,200,300].forEach((d,i)=>setTimeout(()=>this.tone(300+i*100,'square',0.12,0.07),d));}
  startMusic(w){
    this.stopMusic();
    if(!this.ctx)return;
    const bpm=130+w*14,ms=60000/bpm/2;
    const bass=[110,110,130.81,110,146.83,130.81,110,98];
    const mel=[440,0,550,0,440,660,550,0];
    let b=0;
    const gain=this.ctx.createGain();gain.gain.value=0.06;gain.connect(this.ctx.destination);
    this.bi=setInterval(()=>{
      const i=b%8;
      const o=this.ctx.createOscillator(),g=this.ctx.createGain();
      o.type='triangle';o.frequency.value=bass[i];
      g.gain.setValueAtTime(0.06+w*0.015,this.ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+ms/1000*0.8);
      o.connect(g);g.connect(gain);o.start();o.stop(this.ctx.currentTime+ms/1000);
      if(i%2===0){
        const k=this.ctx.createOscillator(),kg=this.ctx.createGain();
        k.type='square';k.frequency.value=42;
        kg.gain.setValueAtTime(0.06+w*0.02,this.ctx.currentTime);
        kg.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+0.07);
        k.connect(kg);kg.connect(gain);k.start();k.stop(this.ctx.currentTime+0.07);
      }
      if(w>1&&mel[i]>0){
        const m=this.ctx.createOscillator(),mg=this.ctx.createGain();
        m.type='square';m.frequency.value=mel[i];
        mg.gain.setValueAtTime(0.015+w*0.004,this.ctx.currentTime);
        mg.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+ms/1000*0.4);
        m.connect(mg);mg.connect(gain);m.start();m.stop(this.ctx.currentTime+ms/1000*0.5);
      }
      b++;
    },ms);
  }
  stopMusic(){if(this.bi){clearInterval(this.bi);this.bi=null;}}
}

// === GAME ===
class Game {
  constructor(){
    this.canvas=document.getElementById('gameCanvas');
    this.c=this.canvas.getContext('2d');
    this.sfx=new SFX();
    this.stars=[];
    for(let i=0;i<80;i++)this.stars.push({x:Math.random()*W,y:Math.random()*320,sz:Math.random()*2.5+0.5,sp:Math.random()*0.3+0.1,a:Math.random()*0.8+0.2});
    this.feedTimer=0;this.feedIdx=0;
    this._lastBossX=W/2;
    this.reset();
  }

  reset(){
    this.enemies=[];this.particles=[];this.powerups=[];this.trails=[];this.confetti=[];
    this.score=0;this.panic=0;this.combo=0;this.maxCombo=0;
    this.totalC=0;this.totalM=0;this.nukesUsed=0;
    this.wave=0;this.waveTime=0;this.running=false;
    this.lastSpawn=0;this.lastPU=0;
    this.nukeCd=0;this.nukeMax=12000;

    // ability cooldowns (adds strategy + prevents spam)
    this.abilityMax={reality:420,history:420,logic:420};
    this.abilityCd={reality:0,history:0,logic:0};

    this.pu={slow:0,shield:0,double:0};
    this.fl=0;this.flCol='#fff';this.shake=0;

    this.boss=null;this.bossPhase=false;
    this.endless=false;
    this.endlessLevel=0;

    // panic i-frames (prevents stacked unfair hits)
    this.panicInvuln=0;
  }

  start(){
    this.reset();
    this.running=true;
    if(!this.sfx.ctx)this.sfx.init();
    this.sfx.resume();
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('end-stats').classList.add('hidden');
    document.getElementById('end-stats').innerHTML='';
    document.getElementById('hype-feed').innerHTML='';
    this.feedIdx=0;
    this.startWave(0);
    this.updateUI();
    this.lastFrame=performance.now();
    requestAnimationFrame(this.loop.bind(this));
  }

  // Boss logical X must match rendered X to avoid ‚Äúphantom misses‚Äù
  getBossX(t){
    if(!this.boss) return W/2;
    this._lastBossX=this.boss.x + Math.sin(t/800)*60;
    return this._lastBossX;
  }

  startWave(idx){
    // Safety: ensure we never stack music intervals
    this.sfx.stopMusic();

    this.wave=idx;this.waveTime=WAVES[Math.min(idx,WAVES.length-1)].dur;
    this.bossPhase=false;this.boss=null;
    document.getElementById('boss-hp-container').style.display='none';

    const a=document.getElementById('wave-announce');
    const isEndless = idx>=WAVES.length;
    const title = isEndless ? `ENDLESS ${idx-(WAVES.length-1)}` : `WAVE ${idx+1}`;
    document.getElementById('wa-title').textContent=title;
    document.getElementById('wa-sub').textContent=isEndless ? `"No more timelines. Just vibes."` : WAVES[idx].sub;
    a.classList.remove('show');void a.offsetWidth;a.classList.add('show');

    this.sfx.waveStart();
    this.sfx.startMusic(Math.min(idx,4));
    this.updateUI();

    if(this.wT)clearInterval(this.wT);
    this.wT=setInterval(()=>{
      this.waveTime--;
      if(this.waveTime<=0){
        clearInterval(this.wT);
        const cfg = WAVES[Math.min(this.wave, WAVES.length-1)];
        if(!this.endless && cfg.boss && !this.bossPhase){
          this.startBoss(cfg.boss);
        } else if(this.endless){
          // Endless just bumps difficulty and continues
          this.nextWave();
        } else {
          this.nextWave();
        }
      }
      this.updateUI();
    },1000);
  }

  startBoss(cfg){
    this.bossPhase=true;this.enemies=[];
    this.boss={name:cfg.name,hp:cfg.hp,maxHp:cfg.hp,pats:cfg.pats,x:W/2,y:-60,targetY:80,timer:0,patIdx:0,spawnCd:0,alive:true,fl:0};
    document.getElementById('boss-hp-container').style.display='block';
    document.getElementById('boss-name').textContent=cfg.name;
    document.getElementById('boss-hp-bar').style.width='100%';
    const a=document.getElementById('wave-announce');
    document.getElementById('wa-title').textContent='‚ö† BOSS ‚ö†';
    document.getElementById('wa-sub').textContent=cfg.name;
    a.classList.remove('show');void a.offsetWidth;a.classList.add('show');
    this.fl=0.3;this.flCol='#e74c3c';
  }

  nextWave(){
    // Victory path: after Wave 5, offer Endless instead of hard end.
    if(!this.endless && this.wave>=WAVES.length-1){
      this.endGame(true);
      return;
    }

    // Endless scaling
    if(this.endless){
      this.endlessLevel++;
      this.waveTime = Math.max(18, 30 - this.endlessLevel*2);
      this.panic=Math.max(0,this.panic-8);
      this.score+=700 + this.endlessLevel*120;
      this.doFlash('#00ffff',0.18);
      setTimeout(()=>this.startWave(WAVES.length + this.endlessLevel - 1),900);
      return;
    }

    this.panic=Math.max(0,this.panic-10);
    this.score+=500*(this.wave+1);
    this.doFlash('#2ecc71',0.25);
    setTimeout(()=>this.startWave(this.wave+1),1500);
  }

  loop(ts){
    if(!this.running)return;
    const dt=Math.min(ts-this.lastFrame,50);this.lastFrame=ts;

    this.nukeCd=Math.max(0,this.nukeCd-dt);
    for(const k in this.pu)this.pu[k]=Math.max(0,this.pu[k]-dt);
    for(const k in this.abilityCd)this.abilityCd[k]=Math.max(0,this.abilityCd[k]-dt);
    this.panicInvuln=Math.max(0,this.panicInvuln-dt);

    this.updatePUHud();
    this.updateCooldownHud();

    // nuke bar
    const nb=document.getElementById('btn-special'),cs=document.getElementById('cd-special');
    if(this.nukeCd>0){nb.classList.add('on-cooldown');cs.style.width=((1-this.nukeCd/this.nukeMax)*100)+'%';}
    else{nb.classList.remove('on-cooldown');cs.style.width='100%';}

    this.shake*=0.9;
    const cfg = this.endless ? this.getEndlessCfg() : WAVES[this.wave];
    const slow=this.pu.slow>0?0.35:1;

    // Momentum perks
    // - combo >= 6 drains panic slightly over time
    if(this.combo>=6 && this.panic>0) this.panic=Math.max(0, this.panic - 0.005*dt);
    // - combo >= 10 grants tiny slow pulses
    if(this.combo>=10 && this.pu.slow<=0 && Math.random()<0.004*(dt/16)) this.pu.slow=600;

    let sx=0,sy=0;
    if(this.shake>0.5){sx=(Math.random()-0.5)*this.shake;sy=(Math.random()-0.5)*this.shake;}

    const c=this.c;
    c.save();c.translate(sx,sy);
    this.drawBG(ts);

    if(this.boss&&this.boss.alive)this.updateBoss(c,dt,ts);
    this.drawChar(W/2,400,this.panic,ts);

    if(!this.bossPhase){
      const rate = cfg.spawn*(this.pu.slow>0?1.5:1);
      const max = cfg.max;
      if(ts-this.lastSpawn>rate && this.enemies.length<max){
        this.spawnEnemy(cfg);
        this.lastSpawn=ts;
      }
    }

    if(ts-this.lastPU>14000 && Math.random()<0.35){this.spawnPU();this.lastPU=ts;}

    this.feedTimer+=dt;
    if(this.feedTimer>3200){this.feedTimer=0;this.addFeed();}

    this.drawEnemies(c,dt,slow,cfg,ts);
    this.drawPUs(c,dt);
    this.drawParts(c,dt);
    this.drawTrails(c,dt);
    this.drawConfetti(c,dt);

    // ‚ÄúReality collapse‚Äù vignette when panic high
    if(this.panic>75){
      c.globalAlpha=0.03 + Math.sin(ts/120)*0.01;
      c.globalCompositeOperation='screen';
      c.fillStyle='#ff00ff';c.fillRect(0,0,W,H);
      c.globalCompositeOperation='source-over';
      c.globalAlpha=1;
    }

    if(this.fl>0){c.globalAlpha=this.fl;c.fillStyle=this.flCol;c.fillRect(0,0,W,H);c.globalAlpha=1;this.fl-=0.04;}
    if(this.pu.slow>0){c.globalAlpha=0.06;c.fillStyle='#3498db';c.fillRect(0,0,W,H);c.globalAlpha=1;}

    c.restore();

    // Clamp panic (prevents overflow weirdness)
    this.panic=Math.min(100, Math.max(0, this.panic));

    requestAnimationFrame(this.loop.bind(this));
  }

  getEndlessCfg(){
    const lvl=this.endlessLevel;
    const base=WAVES[4];
    return {
      name:"ENDLESS",
      sub:"\"No more timelines.\"",
      dur:this.waveTime,
      spawn:Math.max(360, base.spawn - lvl*35),
      max:Math.min(18, base.max + Math.floor(lvl/2)),
      spd:base.spd + lvl*0.07
    };
  }

  // === BG ===
  drawBG(t){
    const c=this.c,p=this.panic,w=Math.min(this.wave,4);
    const gr=c.createLinearGradient(0,0,0,H);
    const r=Math.min(30,10+p*0.25+w*2),g=Math.max(5,12-p*0.08),b=Math.min(40,26+p*0.1);
    gr.addColorStop(0,`rgb(${r},${g},${b})`);
    gr.addColorStop(1,`rgb(${~~(r*0.4)},${~~(g*0.2)},${~~(b*0.3)})`);
    c.fillStyle=gr;c.fillRect(0,0,W,H);

    // Window
    c.fillStyle="#030310";c.fillRect(55,50,210,260);
    c.save();c.beginPath();c.rect(55,50,210,260);c.clip();
    this.stars.forEach(s=>{
      c.globalAlpha=Math.max(0.1,s.a+Math.sin(t/600+s.x+s.y)*0.4);
      c.fillStyle='#fff';c.fillRect(s.x,s.y,s.sz,s.sz);
      s.y+=s.sp*0.02;if(s.y>310)s.y=50;
    });
    c.restore();c.globalAlpha=1;
    c.strokeStyle="#1c2833";c.lineWidth=10;c.strokeRect(55,50,210,260);
    c.lineWidth=2;c.beginPath();c.moveTo(160,50);c.lineTo(160,310);c.stroke();
    c.beginPath();c.moveTo(55,180);c.lineTo(265,180);c.stroke();

    // Moon
    c.fillStyle='#e8e8d0';c.globalAlpha=0.85;c.beginPath();c.arc(200,100,28,0,Math.PI*2);c.fill();
    c.fillStyle='#030310';c.beginPath();c.arc(212,92,24,0,Math.PI*2);c.fill();c.globalAlpha=1;

    // Posters
    c.fillStyle='#12121f';c.fillRect(340,80,100,70);
    c.strokeStyle='#2c3e50';c.lineWidth=2;c.strokeRect(340,80,100,70);
    c.fillStyle='#445';c.font="7px 'Press Start 2P'";c.textAlign='center';
    c.fillText(w<3?"AGI":"AGI IS",390,108);c.fillText(w<3?"SOON":"HERE",390,122);
    if(w>=1){c.fillStyle='#12121f';c.fillRect(560,95,85,65);c.strokeStyle='#2c3e50';c.strokeRect(560,95,85,65);c.fillStyle='#445';c.fillText(w<3?"BUY":"SELL",602,118);c.fillText(w<3?"GPU":"HOUSE",602,132);}

    // Desk
    c.fillStyle="#1c2833";c.fillRect(0,500,W,100);
    c.fillStyle="#17202a";c.fillRect(0,500,W,5);
    c.fillStyle='#0d1117';c.fillRect(320,490,160,18);c.strokeStyle='#1a1a2e';c.strokeRect(320,490,160,18);
    c.fillStyle='#2c3e50';c.fillRect(545,480,22,24);c.fillStyle='#1a252f';c.fillRect(547,482,18,5);
    c.fillStyle='#111';c.fillRect(370,504,60,6);

    // Progressive clutter
    if(w>=1){c.fillStyle='#1a5c2a';c.fillRect(270,480,12,28);c.fillStyle='#2ecc71';c.fillRect(272,482,8,4);}
    if(w>=2){c.fillStyle='#1a5c2a';c.fillRect(285,482,12,26);c.fillStyle='#2ecc71';c.fillRect(287,484,8,4);c.fillStyle='#3d2b1f';c.fillRect(140,488,70,18);c.strokeStyle='#2c1f15';c.strokeRect(140,488,70,18);c.fillStyle='#4a3728';c.fillRect(142,490,66,2);}
    if(w>=3){c.fillStyle='#0a0a14';c.fillRect(600,430,100,70);c.strokeStyle='#1a1a2e';c.lineWidth=3;c.strokeRect(600,430,100,70);c.fillStyle='#111';c.fillRect(640,500,20,5);c.fillStyle='#f1c40f';c.fillRect(480,75,40,36);c.fillStyle='#333';c.font="5px 'Press Start 2P'";c.fillText("HELP",500,92);c.fillText("ME",500,100);}
    if(w>=4){c.strokeStyle='rgba(100,100,100,0.3)';c.lineWidth=2;c.beginPath();c.moveTo(600,500);c.quadraticCurveTo(580,520,550,515);c.stroke();c.fillStyle='rgba(200,200,200,0.08)';c.save();c.translate(180,510);c.rotate(0.2);c.fillRect(0,0,30,20);c.restore();c.save();c.translate(220,515);c.rotate(-0.15);c.fillRect(0,0,25,18);c.restore();}

    // Monitor glow
    const gR=Math.min(255,80+p*2.5+w*10),gG=Math.max(20,180-p*2-w*8),gB=Math.max(40,220-p);
    const glow=c.createRadialGradient(W/2,560,30,W/2,480,350);
    glow.addColorStop(0,`rgba(${gR},${gG},${gB},0.3)`);glow.addColorStop(1,"rgba(0,0,0,0)");
    c.globalCompositeOperation='screen';c.fillStyle=glow;c.fillRect(0,200,W,400);c.globalCompositeOperation='source-over';
  }

  // === CHARACTER ===
  drawChar(cx,cy,p,t){
    const c=this.c,br=Math.sin(t/400)*3;
    c.fillStyle="rgba(0,0,0,0.35)";c.beginPath();c.ellipse(cx,cy+95,65,14,0,0,Math.PI*2);c.fill();
    if(p<33)this.drawNorm(cx,cy,br,t);
    else if(p<66)this.drawPanic(cx,cy,br,t);
    else this.drawDuck(cx,cy,p,br,t);
  }

  drawNorm(cx,cy,br,t){
    const c=this.c;
    c.fillStyle='#1a1a2e';c.beginPath();c.ellipse(cx,cy+85,52,22,0,0,Math.PI*2);c.fill();
    c.fillStyle="#3498db";c.beginPath();c.ellipse(cx,cy+58+br,40,48,0,0,Math.PI*2);c.fill();
    c.fillStyle="#ffdbac";c.fillRect(cx-7,cy+10,14,14);
    c.beginPath();c.arc(cx,cy-14,42,0,Math.PI*2);c.fill();
    c.fillStyle="#3d2b1f";c.beginPath();c.arc(cx,cy-24,43,Math.PI,0);c.lineTo(cx+43,cy-14);c.lineTo(cx+34,cy+4);c.lineTo(cx-34,cy+4);c.lineTo(cx-43,cy-14);c.fill();
    c.beginPath();c.moveTo(cx-4,cy-56);c.lineTo(cx+6,cy-68);c.lineTo(cx+15,cy-55);c.fill();
    c.fillStyle="white";c.beginPath();c.arc(cx-14,cy-8,9,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+14,cy-8,9,0,Math.PI*2);c.fill();
    c.fillStyle="#222";c.beginPath();c.arc(cx-14,cy-8,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+14,cy-8,3,0,Math.PI*2);c.fill();
    c.fillStyle="#fff";c.beginPath();c.arc(cx-12,cy-10,1.2,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+16,cy-10,1.2,0,Math.PI*2);c.fill();
    c.strokeStyle="#3d2b1f";c.lineWidth=2.5;c.beginPath();c.moveTo(cx-22,cy-22);c.lineTo(cx-7,cy-19);c.stroke();c.beginPath();c.moveTo(cx+7,cy-22);c.lineTo(cx+22,cy-25);c.stroke();
    c.strokeStyle="#c0392b";c.lineWidth=2;c.beginPath();c.moveTo(cx-7,cy+14);c.lineTo(cx+7,cy+14);c.stroke();
    c.fillStyle="#3498db";c.fillRect(cx-50,cy+48,18,38);c.fillRect(cx+32,cy+48,18,38);
    c.fillStyle="#ffdbac";c.beginPath();c.arc(cx-41,cy+84,7,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+41,cy+84,7,0,Math.PI*2);c.fill();
    this.drawSpeech(cx,cy,"Is this even real?","#778",t);
  }

  drawPanic(cx,cy,br,t){
    const c=this.c,sh=Math.sin(t/40)*3;
    c.fillStyle='#1a1a2e';c.beginPath();c.ellipse(cx,cy+85,52,22,0,0,Math.PI*2);c.fill();
    c.fillStyle="#2471a3";c.beginPath();c.ellipse(cx+sh,cy+58+br,42,50,0,0,Math.PI*2);c.fill();
    c.fillStyle="#f5cba7";c.fillRect(cx-7+sh,cy+8,14,14);c.beginPath();c.arc(cx+sh,cy-14,44,0,Math.PI*2);c.fill();
    c.fillStyle="#3d2b1f";c.beginPath();c.arc(cx+sh,cy-24,45,Math.PI,0);c.lineTo(cx+sh+45,cy-14);c.lineTo(cx+sh+34,cy+4);c.lineTo(cx+sh-34,cy+4);c.lineTo(cx+sh-45,cy-14);c.fill();
    c.beginPath();c.moveTo(cx+sh-12,cy-58);c.lineTo(cx+sh-20,cy-76);c.lineTo(cx+sh-6,cy-60);c.fill();
    c.beginPath();c.moveTo(cx+sh+8,cy-60);c.lineTo(cx+sh+18,cy-78);c.lineTo(cx+sh+22,cy-58);c.fill();
    c.fillStyle="white";c.beginPath();c.arc(cx+sh-14,cy-8,12,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+sh+14,cy-8,12,0,Math.PI*2);c.fill();
    c.fillStyle="#222";c.beginPath();c.arc(cx+sh-14,cy-8,1.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+sh+14,cy-8,1.5,0,Math.PI*2);c.fill();
    c.fillStyle='#111';c.beginPath();c.ellipse(cx+sh,cy+18,9,6,0,0,Math.PI*2);c.fill();
    c.fillStyle="#f5cba7";c.beginPath();c.moveTo(cx+sh-42,cy+38);c.lineTo(cx+sh-55,cy);c.lineTo(cx+sh-38,cy-22);c.lineTo(cx+sh-25,cy+8);c.fill();
    c.beginPath();c.moveTo(cx+sh+42,cy+38);c.lineTo(cx+sh+55,cy);c.lineTo(cx+sh+38,cy-22);c.lineTo(cx+sh+25,cy+8);c.fill();
    if(~~(t/150)%2===0){c.fillStyle="#5dade2";c.beginPath();c.arc(cx+sh+48,cy,3.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(cx+sh-48,cy+4,3,0,Math.PI*2);c.fill();}
    c.strokeStyle='rgba(231,76,60,0.25)';c.lineWidth=1;
    for(let i=0;i<4;i++){const a=(t/250+i*1.6)%(Math.PI*2);c.beginPath();c.moveTo(cx+sh+Math.cos(a)*55,cy-14+Math.sin(a)*55);c.lineTo(cx+sh+Math.cos(a)*68,cy-14+Math.sin(a)*68);c.stroke();}
    this.drawSpeech(cx+sh,cy,"IT'S EXPONENTIAL!!!","#f1c40f",t);
  }

  drawDuck(cx,cy,p,br,t){
    const c=this.c,sh=(Math.random()-0.5)*7;
    const as=75+Math.sin(t/200)*18;
    const aura=c.createRadialGradient(cx,cy,25,cx,cy,as);
    aura.addColorStop(0,`rgba(241,196,15,${0.12+Math.sin(t/150)*0.08})`);
    aura.addColorStop(0.6,`rgba(142,68,173,${0.08+Math.sin(t/200)*0.04})`);
    aura.addColorStop(1,"rgba(0,0,0,0)");
    c.fillStyle=aura;c.fillRect(cx-120,cy-120,240,240);
    c.fillStyle="#f1c40f";c.beginPath();c.ellipse(cx+sh*0.5,cy+55,50+br,55-br,0,0,Math.PI*2);c.fill();
    c.strokeStyle="#d4ac0d";c.lineWidth=2.5;c.stroke();
    c.fillStyle="#f1c40f";c.beginPath();c.arc(cx+sh,cy-8,48,0,Math.PI*2);c.fill();c.stroke();
    c.strokeStyle="#222";c.lineWidth=3.5;const hx=cx+sh,hy=cy-56;
    c.beginPath();c.moveTo(hx,hy);c.lineTo(hx,hy-26);c.stroke();
    c.beginPath();c.moveTo(hx,hy);c.lineTo(hx-13,hy-22);c.stroke();
    c.beginPath();c.moveTo(hx,hy);c.lineTo(hx+13,hy-22);c.stroke();
    c.fillStyle="white";c.strokeStyle="#222";c.lineWidth=2;
    c.beginPath();c.arc(cx+sh-20,cy-16,14,0,Math.PI*2);c.fill();c.stroke();
    c.beginPath();c.arc(cx+sh+20,cy-16,14,0,Math.PI*2);c.fill();c.stroke();
    c.fillStyle="#111";c.beginPath();c.arc(cx+sh-20,cy-16,1.5,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(cx+sh+20,cy-16,1.5,0,Math.PI*2);c.fill();
    c.fillStyle="#f0b27a";c.strokeStyle="#d68910";c.lineWidth=2;
    c.beginPath();c.ellipse(cx+sh,cy+6,24,9,0,0,Math.PI*2);c.fill();c.stroke();
    c.fillStyle="#f1c40f";c.strokeStyle="#d4ac0d";c.lineWidth=2;
    c.beginPath();c.ellipse(cx+sh-44,cy+10,12,28,-0.4,0,Math.PI*2);c.fill();c.stroke();
    c.beginPath();c.ellipse(cx+sh+44,cy+10,12,28,0.4,0,Math.PI*2);c.fill();c.stroke();
    c.globalAlpha=0.35;const wc=Math.floor(p/18);
    for(let i=0;i<wc;i++){const r=58+i*18+Math.sin(t/150+i)*8;c.strokeStyle=i%2===0?'#8e44ad':'#f1c40f';c.lineWidth=2;c.beginPath();c.arc(cx+sh,cy-8,Math.max(1,r),0,Math.PI*2);c.stroke();}
    c.globalAlpha=1;
    if(p>80){for(let i=0;i<3;i++){const a=t/100+i*(Math.PI*2/3),d=50+Math.sin(t/80+i)*8;c.fillStyle='#f1c40f';c.font='13px Arial';c.fillText('‚ö°',cx+sh+Math.cos(a)*d-7,cy-8+Math.sin(a)*d+5);}}
    this.drawSpeech(cx+sh,cy,"PSY-AY-AY!!!","#e74c3c",t);
  }

  drawSpeech(cx,cy,txt,col,t){
    const c=this.c,bob=Math.sin(t/500)*3;
    c.font="10px 'Press Start 2P'";c.fillStyle=col;c.textAlign="center";
    c.shadowColor="rgba(0,0,0,0.8)";c.shadowBlur=6;c.fillText(txt,cx,cy-80+bob);c.shadowBlur=0;
  }

  // === BOSS ===
  updateBoss(c,dt,t){
    const b=this.boss;
    if(b.y<b.targetY)b.y+=2*(dt/16);
    else{
      b.timer+=dt;b.spawnCd+=dt;
      const pat=b.pats[b.patIdx%b.pats.length];
      const interval=pat==='sweep'?800:pat==='spiral'?500:1200;
      if(b.spawnCd>interval){b.spawnCd=0;this.bossFire(pat);}
      if(b.timer>5000){b.timer=0;b.patIdx++;}
    }
    const bx=this.getBossX(t),by=b.y;
    const g=c.createRadialGradient(bx,by,20,bx,by,90);
    g.addColorStop(0,'rgba(231,76,60,0.25)');g.addColorStop(1,'rgba(0,0,0,0)');
    c.fillStyle=g;c.fillRect(bx-100,by-100,200,200);
    const pulse=Math.sin(t/200)*4;
    c.fillStyle=b.fl>0?'#fff':'#e74c3c';b.fl=Math.max(0,b.fl-dt*0.005);
    c.beginPath();c.arc(bx,by,45+pulse,0,Math.PI*2);c.fill();
    c.strokeStyle='#fff';c.lineWidth=3;c.stroke();
    c.fillStyle='#fff';c.font="28px Arial";c.textAlign='center';
    c.fillText(this.wave>=4?'üß†':'üöÇ',bx,by+10);
    c.font="8px 'Press Start 2P'";c.fillStyle='#fff';c.fillText(`${b.hp}/${b.maxHp}`,bx,by-52);
    for(let i=0;i<3;i++){
      const a=t/600+i*(Math.PI*2/3),ox=bx+Math.cos(a)*65,oy=by+Math.sin(a)*35;
      c.globalAlpha=0.4;c.fillStyle=['#e67e22','#2ecc71','#9b59b6'][i];
      c.beginPath();c.arc(ox,oy,8,0,Math.PI*2);c.fill();c.globalAlpha=1;
    }
    document.getElementById('boss-hp-bar').style.width=(b.hp/b.maxHp*100)+'%';
  }

  bossFire(pat){
    const keys=Object.keys(TYPES);
    const mk=(variant='normal')=>{
      const k=keys[~~(Math.random()*3)],td=TYPES[k];
      return{
        x:150+Math.random()*(W-300),
        y:this.boss.y+50,
        speed:2.5+Math.random(),
        type:td,word:td.words[~~(Math.random()*td.words.length)],key:k,
        radius:variant==='splitter'?36:30,
        wobble:Math.random()*6,wobbleSpeed:1+Math.random(),
        variant, encrypted:false
      };
    };
    if(pat==='burst')for(let i=0;i<3;i++)this.enemies.push(mk());
    else if(pat==='sweep'){
      const k=keys[~~(Math.random()*3)],td=TYPES[k];
      for(let i=0;i<4;i++)this.enemies.push({x:120+i*160,y:this.boss.y+50,speed:2.2,type:td,word:td.words[~~(Math.random()*td.words.length)],key:k,radius:28,wobble:i,wobbleSpeed:0.8,variant:'normal',encrypted:false});
    }
    else if(pat==='spiral'){for(let i=0;i<2;i++)this.enemies.push(mk('splitter'));}
  }

  hitBoss(amount=1){
    if(!this.boss||!this.boss.alive)return;
    this.boss.hp-=amount;
    this.boss.fl=1;
    this.sfx.bossHit();
    this.score+=200*amount;
    if(this.boss.hp<=0){
      this.boss.alive=false;
      this.sfx.bossDie();
      this.doFlash('#f1c40f',0.5);
      this.shake+=15;
      this.score+=2000;
      const bx=this.getBossX(performance.now());
      for(let i=0;i<40;i++)this.particles.push({x:bx,y:this.boss.y,vx:(Math.random()-0.5)*20,vy:(Math.random()-0.5)*20-3,life:1,color:['#e74c3c','#f1c40f','#fff'][~~(Math.random()*3)],size:Math.random()*8+3});
      document.getElementById('boss-hp-container').style.display='none';
      this.createText("BOSS DEFEATED!",W/2,200,"#f1c40f",true);
      setTimeout(()=>this.nextWave(),2000);
    }
  }

  // === ENEMIES ===
  spawnEnemy(cfg){
    const keys=Object.keys(TYPES),k=keys[~~(Math.random()*3)],td=TYPES[k];
    let variant='normal';
    const roll=Math.random();
    if(this.wave>=2 && roll<0.12)variant='splitter';
    else if(this.wave>=1 && roll<0.22)variant='speeder';
    else if(this.wave>=3 && roll<0.30)variant='encrypted';

    // endless makes variants a bit spicier
    if(this.endless && roll<0.18)variant='encrypted';
    if(this.endless && roll>0.92)variant='splitter';

    this.enemies.push({
      x:80+Math.random()*(W-160),y:-40,
      speed:(1.2+Math.random()*1.5)*cfg.spd*(variant==='speeder'?1.8:1),
      type:td,word:td.words[~~(Math.random()*td.words.length)],key:k,
      radius:variant==='splitter'?36:variant==='speeder'?24:30,
      wobble:Math.random()*Math.PI*2,wobbleSpeed:0.5+Math.random()*(variant==='speeder'?3:1.5),
      variant,
      encrypted:variant==='encrypted',
      revealY:H*0.55,
      // for click/tap selection
      screenX:0,screenY:0
    });
  }

  drawEnemies(c,dt,slow,cfg,t){
    for(let i=this.enemies.length-1;i>=0;i--){
      const e=this.enemies[i];
      e.y+=e.speed*slow*(dt/16);e.wobble+=e.wobbleSpeed*0.02;
      const wx=Math.sin(e.wobble)*(e.variant==='speeder'?25:15);
      const ex=e.x+wx,ey=e.y;
      e.screenX=ex; e.screenY=ey;

      const hidden=e.encrypted&&e.y<e.revealY;

      c.beginPath();c.moveTo(W/2,360);c.lineTo(ex,ey);
      c.strokeStyle='rgba(255,255,255,0.05)';c.lineWidth=1;c.setLineDash([4,6]);c.stroke();c.setLineDash([]);

      const gc=c.createRadialGradient(ex,ey,3,ex,ey,e.radius+8);
      gc.addColorStop(0,hidden?'#555':e.type.color);gc.addColorStop(1,'rgba(0,0,0,0)');
      c.globalAlpha=0.2;c.fillStyle=gc;c.beginPath();c.arc(ex,ey,e.radius+8,0,Math.PI*2);c.fill();c.globalAlpha=1;

      c.fillStyle=hidden?'#444':e.type.color;
      c.beginPath();c.arc(ex,ey,e.radius,0,Math.PI*2);c.fill();

      if(e.variant==='splitter'){c.strokeStyle='rgba(255,255,255,0.7)';c.lineWidth=2;c.stroke();c.strokeStyle='rgba(255,255,255,0.3)';c.lineWidth=1;c.beginPath();c.moveTo(ex,ey-e.radius);c.lineTo(ex,ey+e.radius);c.stroke();}
      else if(e.variant==='speeder'){c.strokeStyle='rgba(255,255,0,0.6)';c.lineWidth=2;c.stroke();c.globalAlpha=0.15;c.fillStyle=e.type.color;c.beginPath();c.arc(ex,ey+12,e.radius*0.8,0,Math.PI*2);c.fill();c.beginPath();c.arc(ex,ey+22,e.radius*0.5,0,Math.PI*2);c.fill();c.globalAlpha=1;}
      else if(hidden){c.strokeStyle='rgba(255,255,255,0.3)';c.lineWidth=2;c.stroke();c.fillStyle='#aaa';c.font="14px 'Press Start 2P'";c.textAlign='center';c.fillText('?',ex,ey+5);}
      else{c.strokeStyle='rgba(255,255,255,0.5)';c.lineWidth=2;c.stroke();}

      if(!hidden){
        c.fillStyle='rgba(255,255,255,0.15)';c.beginPath();c.arc(ex-6,ey-8,6,0,Math.PI*2);c.fill();
        c.font="14px Arial";c.textAlign='center';c.fillText(e.type.icon,ex,ey-8);
        c.fillStyle="white";c.font="7px 'Press Start 2P'";c.fillText(e.word,ex,ey+10);
      }

      if(ey>H-95){
        if(this.pu.shield>0){
          this.mkParts(ex,ey,'#2ecc71',8);
          this.createText("BLOCKED!",ex,ey,"#2ecc71");
        } else if(this.panicInvuln<=0){
          const dmg=e.variant==='splitter'?10:8;
          this.panic+=dmg;
          this.panicInvuln=250; // i-frames
          this.combo=0;
          this.shake+=5;
          this.sfx.panicHit();
          this.createText(`PANIC +${dmg}`,ex,ey,"#e74c3c");
          if(this.panic>=100){this.endGame(false);return;}
        }
        this.enemies.splice(i,1);
      }
    }
  }

  // === POWERUPS ===
  spawnPU(){
    const t=POWERUPS[~~(Math.random()*POWERUPS.length)];
    this.powerups.push({x:80+Math.random()*(W-160),y:-30,speed:1.1,type:t,radius:16,time:0});
  }

  drawPUs(c,dt){
    for(let i=this.powerups.length-1;i>=0;i--){
      const p=this.powerups[i];
      p.y+=p.speed*(dt/16);p.time+=dt;
      const bob=Math.sin(p.time/300)*5;
      c.globalAlpha=0.15;
      const g=c.createRadialGradient(p.x,p.y+bob,4,p.x,p.y+bob,28);
      g.addColorStop(0,p.type.color);g.addColorStop(1,'transparent');
      c.fillStyle=g;c.beginPath();c.arc(p.x,p.y+bob,28,0,Math.PI*2);c.fill();
      c.globalAlpha=1;
      c.fillStyle='rgba(0,0,0,0.7)';c.strokeStyle=p.type.color;c.lineWidth=2;
      c.beginPath();c.arc(p.x,p.y+bob,p.radius,0,Math.PI*2);c.fill();c.stroke();
      c.font='14px Arial';c.textAlign='center';c.fillText(p.type.icon,p.x,p.y+bob+5);

      const dx=p.x-W/2,dy=(p.y+bob)-400;
      if(Math.sqrt(dx*dx+dy*dy)<75){
        this.pu[p.type.id]=p.type.dur;
        this.sfx.powerup();
        this.doFlash(p.type.color,0.12);
        this.createText(p.type.name+"!",W/2,350,p.type.color,true);
        this.mkParts(p.x,p.y+bob,p.type.color,18);
        this.powerups.splice(i,1);
        continue;
      }
      if(p.y>H+30)this.powerups.splice(i,1);
    }
  }

  // === ACTIONS ===
  canUse(name){return this.abilityCd[name]<=0;}
  spendCd(name){this.abilityCd[name]=this.abilityMax[name];}

  triggerAbility(name){
    if(!this.running)return;
    if(!this.canUse(name)){ this.sfx.miss(); return; }

    this.spendCd(name);

    const btn=document.querySelector(`.btn.${name}`);
    if(btn){btn.classList.add('pressed');setTimeout(()=>btn.classList.remove('pressed'),100);}

    let hit=false,hc=0;
    const cfg = this.endless ? this.getEndlessCfg() : WAVES[this.wave];

    for(let i=this.enemies.length-1;i>=0;i--){
      const e=this.enemies[i];
      if(e.type.counter===name){
        const wx=Math.sin(e.wobble)*15;
        this.mkParts(e.x+wx,e.y,e.type.color,16);
        this.trails.push({x:e.x+wx,y:e.y,radius:45,color:e.type.color,life:1});
        this.createText("COUNTERED!",e.x+wx,e.y,"#2ecc71");

        // splitter: spawn children but cap to avoid floods; children can't re-split
        if(e.variant==='splitter'){
          const cap = cfg.max + 2;
          if(this.enemies.length < cap){
            const keys=Object.keys(TYPES);
            for(let j=0;j<2;j++){
              if(this.enemies.length >= cap) break;
              const k=keys[~~(Math.random()*3)],td=TYPES[k];
              this.enemies.push({
                x:e.x+wx+(j?40:-40),y:e.y,speed:e.speed*0.8,
                type:td,word:td.words[~~(Math.random()*td.words.length)],key:k,
                radius:20,wobble:Math.random()*6,wobbleSpeed:1.5,
                variant:'child',encrypted:false,revealY:H*0.55,screenX:0,screenY:0
              });
            }
            this.createText("SPLIT!",e.x+wx,e.y-20,"#f39c12");
          }
        }

        this.enemies.splice(i,1);
        hit=true;hc++;this.totalC++;

        // boss: one hit per counter action (not per enemy removed)
      }
    }

    if(hit){
      if(this.bossPhase) this.hitBoss(1);

      this.combo+=hc;if(this.combo>this.maxCombo)this.maxCombo=this.combo;
      this.score+=100*this.combo*(this.pu.double>0?2:1);
      this.sfx.counter(this.combo);

      if(this.combo>3)this.panic=Math.max(0,this.panic-1.5);
      if(this.combo>6)this.doFlash('#f1c40f',0.08);
      this.shake+=Math.min(this.combo*0.5,4);
    }else{
      this.combo=0;
      this.score=Math.max(0,this.score-25);
      this.totalM++;
      this.createText("MISS!",W/2,H/2-50,"#555");
      this.sfx.miss();
    }
    this.updateUI();
  }

  triggerNuke(){
    if(!this.running||this.nukeCd>0)return;
    this.nukeCd=this.nukeMax;this.nukesUsed++;this.sfx.nuke();this.doFlash('#fff',0.45);this.shake+=12;

    // Fix: nuke should not multi-hit boss once per enemy.
    const bossHits = this.bossPhase ? Math.min(2, 1 + Math.floor(this.enemies.length/8)) : 0;

    for(const e of this.enemies){
      const wx=Math.sin(e.wobble)*15;
      this.mkParts(e.x+wx,e.y,e.type.color,10);
      this.trails.push({x:e.x+wx,y:e.y,radius:55,color:'#fff',life:1});
      this.totalC++;
    }

    this.score+=this.enemies.length*50;
    this.enemies=[];
    this.combo=0;

    if(this.bossPhase && bossHits>0) this.hitBoss(bossHits);

    this.createText("NUKE!!!",W/2,H/2-80,"#e74c3c",true);
    this.updateUI();
  }

  // === EFFECTS ===
  mkParts(x,y,color,n=15){for(let i=0;i<n;i++)this.particles.push({x,y,vx:(Math.random()-0.5)*14,vy:(Math.random()-0.5)*14-2,life:1,color,size:Math.random()*5+2});}
  drawParts(c,dt){
    for(let i=this.particles.length-1;i>=0;i--){
      const p=this.particles[i];
      p.x+=p.vx*(dt/16);p.y+=p.vy*(dt/16);p.vy+=0.3;
      p.life-=0.025*(dt/16);
      c.globalAlpha=Math.max(0,p.life);
      c.fillStyle=p.color;
      c.beginPath();c.arc(p.x,p.y,Math.max(0.1,p.size*p.life),0,Math.PI*2);c.fill();
      c.globalAlpha=1;
      if(p.life<=0)this.particles.splice(i,1);
    }
  }
  drawTrails(c,dt){
    for(let i=this.trails.length-1;i>=0;i--){
      const t=this.trails[i];
      t.life-=0.03*(dt/16);
      c.globalAlpha=Math.max(0,t.life*0.4);
      c.strokeStyle=t.color;
      c.lineWidth=t.life*3;
      c.beginPath();c.arc(t.x,t.y,Math.max(0.1,t.radius*(1-t.life)),0,Math.PI*2);c.stroke();
      c.globalAlpha=1;
      if(t.life<=0)this.trails.splice(i,1);
    }
  }
  drawConfetti(c,dt){
    for(let i=this.confetti.length-1;i>=0;i--){
      const p=this.confetti[i];
      p.x+=p.vx*(dt/16);p.y+=p.vy*(dt/16);p.vy+=0.15;p.rot+=p.rv*(dt/16);
      p.life-=0.006*(dt/16);
      c.save();c.translate(p.x,p.y);c.rotate(p.rot);
      c.globalAlpha=Math.max(0,p.life);
      c.fillStyle=p.color;c.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      c.restore();c.globalAlpha=1;
      if(p.life<=0)this.confetti.splice(i,1);
    }
  }
  spawnConfetti(){
    const cols=['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#fff','#e67e22','#1abc9c'];
    for(let i=0;i<120;i++)this.confetti.push({x:Math.random()*W,y:-10-Math.random()*100,vx:(Math.random()-0.5)*6,vy:Math.random()*3+1,w:Math.random()*8+3,h:Math.random()*4+2,rot:Math.random()*Math.PI*2,rv:(Math.random()-0.5)*0.2,life:1,color:cols[~~(Math.random()*cols.length)]});
  }

  createText(text,x,y,color,isPU=false){
    const el=document.createElement('div');
    el.className='damage-text'+(isPU?' powerup-text':'');
    el.style.left=x+'px';el.style.top=y+'px';el.style.color=color;el.style.transform='translateX(-50%)';
    el.textContent=text;
    document.getElementById('game-container').appendChild(el);
    setTimeout(()=>el.remove(),isPU?1500:1000);
  }

  doFlash(col,a){this.fl=a;this.flCol=col;}

  updateCooldownHud(){
    const map=[
      ['reality','btn-reality','cd-reality'],
      ['history','btn-history','cd-history'],
      ['logic','btn-logic','cd-logic'],
    ];
    for(const [k,btnId,barId] of map){
      const btn=document.getElementById(btnId);
      const bar=document.getElementById(barId);
      const rem=this.abilityCd[k],mx=this.abilityMax[k];
      if(rem>0){
        btn.classList.add('on-cooldown');
        bar.style.width=((1-rem/mx)*100)+'%';
      }else{
        btn.classList.remove('on-cooldown');
        bar.style.width='100%';
      }
    }
  }

  updateUI(){
    document.getElementById('panic-bar').style.width=Math.min(100,this.panic)+"%";
    document.getElementById('score-display').textContent=this.score;
    document.getElementById('time-display').textContent=this.waveTime;

    const waveText = this.endless
      ? `ENDLESS ${this.endlessLevel+1}`
      : `WAVE ${this.wave+1}`;
    document.getElementById('wave-display').textContent=waveText;

    const ce=document.getElementById('combo-display'),cv=Math.max(1,this.combo);
    ce.textContent="COMBO: x"+cv;
    ce.style.transform=cv>1?`scale(${1+cv/12})`:"scale(1)";
    ce.style.color=cv>6?"#e74c3c":cv>3?"#f39c12":"#f1c40f";
  }

  updatePUHud(){
    for(const k of['slow','shield','double']){
      const el=document.getElementById('pu-'+k);
      if(this.pu[k]>0)el.classList.add('active');
      else el.classList.remove('active');
    }
  }

  addFeed(){
    const feed=document.getElementById('hype-feed'),post=FEED[this.feedIdx%FEED.length];this.feedIdx++;
    const div=document.createElement('div');div.className='feed-item';
    div.innerHTML=`<div class="feed-user">${post[0]}</div>${post[1]}<div class="feed-engagement">${post[2]}</div>`;
    feed.appendChild(div);setTimeout(()=>div.remove(),18000);
    while(feed.children.length>12)feed.removeChild(feed.firstChild);
  }

  endGame(win){
    this.running=false;if(this.wT)clearInterval(this.wT);this.sfx.stopMusic();
    if(win)this.spawnConfetti();

    const overlay=document.getElementById('overlay'),
          title=document.getElementById('overlay-title'),
          desc=document.getElementById('overlay-desc'),
          stats=document.getElementById('end-stats');

    overlay.classList.remove('hidden');

    const acc=this.totalC/Math.max(1,this.totalC+this.totalM);
    let grade,gc;
    if(win&&acc>0.9&&this.maxCombo>8){grade='S';gc='grade-s';}
    else if(win&&acc>0.75){grade='A';gc='grade-a';}
    else if(win){grade='B';gc='grade-b';}
    else if(this.wave>=3){grade='C';gc='grade-c';}
    else{grade='D';gc='grade-d';}

    if(win){
      title.textContent="CRISIS AVERTED";
      title.style.color="#2ecc71";
      title.style.textShadow="4px 4px 0 #145a32, 0 0 40px rgba(46,204,113,0.3)";
      desc.innerHTML=`He closes the laptop. Sunlight enters the room.<br>"Maybe I should touch grass."<br><br><span style="color:#00ffff">Press <b>SPACE</b> for ENDLESS MODE.</span>`;
    } else {
      title.textContent="BRAIN MELTDOWN";
      title.style.color="#e74c3c";
      title.style.textShadow="4px 4px 0 #7b241c, 0 0 40px rgba(231,76,60,0.3)";
      desc.innerHTML=`Full Psyduck transformation complete.<br>He just pre-ordered 5,000 H100s.`;
    }

    stats.classList.remove('hidden');
    stats.innerHTML=`<div class="grade ${gc}">${grade}</div>
      <div class="stat-row"><span class="stat-label">FINAL SCORE</span><span class="stat-value">${this.score.toLocaleString()}</span></div>
      <div class="stat-row"><span class="stat-label">WAVES CLEARED</span><span class="stat-value">${win?5:this.wave+1} / 5</span></div>
      <div class="stat-row"><span class="stat-label">MAX COMBO</span><span class="stat-value">x${this.maxCombo}</span></div>
      <div class="stat-row"><span class="stat-label">COUNTERED</span><span class="stat-value">${this.totalC}</span></div>
      <div class="stat-row"><span class="stat-label">ACCURACY</span><span class="stat-value">${Math.round(acc*100)}%</span></div>
      <div class="stat-row"><span class="stat-label">NUKES USED</span><span class="stat-value">${this.nukesUsed}</span></div>`;

    document.getElementById('start-btn').textContent=win?'PLAY AGAIN':'RETRY';
  }

  // Click/tap helper: find nearest enemy under pointer
  findEnemyAt(x,y){
    let best=null,bd=1e9;
    for(const e of this.enemies){
      const dx=e.screenX-x,dy=e.screenY-y;
      const d=Math.hypot(dx,dy);
      const r=e.radius+6;
      if(d<r && d<bd){bd=d;best=e;}
    }
    return best;
  }
}

const game=new Game();

function startGame(){game.start();}

document.addEventListener('keydown',e=>{
  if(e.key==='1')game.triggerAbility('reality');
  else if(e.key==='2')game.triggerAbility('history');
  else if(e.key==='3')game.triggerAbility('logic');
  else if(e.key==='q'||e.key==='Q')game.triggerNuke();
  else if(e.key===' '){
    e.preventDefault();
    if(!game.running){
      // If last screen was win, allow continuing into endless.
      const title=document.getElementById('overlay-title').textContent;
      if(title==="CRISIS AVERTED"){
        game.endless=true;
        document.getElementById('overlay').classList.add('hidden');
        game.running=true;
        if(!game.sfx.ctx)game.sfx.init();
        game.sfx.resume();
        game.startWave(WAVES.length); // begin endless
        game.lastFrame=performance.now();
        requestAnimationFrame(game.loop.bind(game));
      }else{
        startGame();
      }
    }
  }
});

// Buttons
document.getElementById('btn-reality').addEventListener('click',()=>game.triggerAbility('reality'));
document.getElementById('btn-history').addEventListener('click',()=>game.triggerAbility('history'));
document.getElementById('btn-logic').addEventListener('click',()=>game.triggerAbility('logic'));
document.getElementById('btn-special').addEventListener('click',()=>game.triggerNuke());

// Tap/click enemies to auto-counter (mobile-friendly)
function pointerToCanvas(e){
  const rect=game.canvas.getBoundingClientRect();
  const x=((e.clientX-rect.left)/rect.width)*W;
  const y=((e.clientY-rect.top)/rect.height)*H;
  return {x,y};
}
game.canvas.addEventListener('pointerdown', (e)=>{
  if(!game.running) return;
  const {x,y}=pointerToCanvas(e);
  const enemy=game.findEnemyAt(x,y);
  if(enemy && !enemy.encrypted){
    game.triggerAbility(enemy.type.counter);
  }
});

document.addEventListener('touchstart',e=>{if(e.touches.length>1)e.preventDefault();},{passive:false});
</script>

</body>
</html>
